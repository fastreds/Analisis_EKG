<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formulario AngioTC - Dinámico (CAD-RADS)</title>
  <!-- Tailwind CDN para estilo rápido -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF para generar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* pequeños ajustes para tactilidad */
    .touch-btn { min-width: 44px; min-height: 44px; padding: .5rem 1rem; }
    .card { -webkit-tap-highlight-color: rgba(0,0,0,0.05); }
    /* for better printing from PDF (optional) */
    @media print {
      .no-print { display:none; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold">Formulario AngioTC Cardiaco — Versión Dinámica</h1>
      <p class="text-sm text-slate-600">Form diseñado para rellenado rápido en dispositivos táctiles. Calcula CAD-RADS automáticamente y permite pre-carga de escenarios.</p>
    </header>

    <!-- Controles superiores: precarga y generación PDF -->
    <div class="flex gap-2 flex-wrap mb-4 no-print">
      <button id="btnPreload" class="bg-blue-600 text-white rounded-lg touch-btn shadow hover:bg-blue-700">Precargar datos (Escenario)</button>
      <button id="btnAddArtery" class="bg-green-600 text-white rounded-lg touch-btn shadow hover:bg-green-700">Añadir vaso</button>
      <button id="btnGenerate" class="bg-indigo-600 text-white rounded-lg touch-btn shadow hover:bg-indigo-700">Generar PDF</button>
      <button id="btnReset" class="bg-red-600 text-white rounded-lg touch-btn shadow hover:bg-red-700">Reset</button>
    </div>

    <form id="angioForm" class="space-y-4 bg-white p-4 rounded-xl shadow">
      <!-- Sección: Datos del paciente -->
      <section class="card p-3 border rounded-lg">
        <h2 class="font-medium text-lg mb-2">Datos del paciente</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input name="nombre" placeholder="Nombre completo" class="p-3 border rounded-lg touch-btn" />
          <input name="identificacion" placeholder="Identificación" class="p-3 border rounded-lg touch-btn" />
          <select name="genero" class="p-3 border rounded-lg touch-btn">
            <option value="">Género</option>
            <option>Masculino</option>
            <option>Femenino</option>
            <option>Otro</option>
          </select>
          <input name="edad" type="number" placeholder="Edad (años)" class="p-3 border rounded-lg touch-btn" />
          <input name="peso" type="number" step="0.1" placeholder="Peso (kg)" class="p-3 border rounded-lg touch-btn" />
          <input name="talla" type="number" step="0.1" placeholder="Talla (cm)" class="p-3 border rounded-lg touch-btn" />
          <input name="area_sc" type="number" step="0.01" placeholder="Área SC (m2)" class="p-3 border rounded-lg touch-btn" />
          <input name="fecha_estudio" type="date" class="p-3 border rounded-lg touch-btn" />
        </div>
      </section>

      <!-- Sección: Datos técnicos -->
      <section class="card p-3 border rounded-lg">
        <h2 class="font-medium text-lg mb-2">Datos técnicos del estudio</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input name="tomografo" placeholder="Tomógrafo (ej. Canon Aquilion 160cortes)" class="p-3 border rounded-lg touch-btn" />
          <input name="tiempo_rotacion" placeholder="Tiempo de rotación (s)" class="p-3 border rounded-lg touch-btn" />
          <select name="ecg_gating" class="p-3 border rounded-lg touch-btn">
            <option value="">ECG-gating</option>
            <option>Retrospectivo</option>
            <option>Prospectivo</option>
          </select>
          <input name="medio_contraste" placeholder="Medio contraste (ej. Ultravist 370)" class="p-3 border rounded-lg touch-btn" />
          <input name="volumen_contraste" type="number" placeholder="Volumen (ml)" class="p-3 border rounded-lg touch-btn" />
          <input name="velocidad_infusion" type="number" step="0.1" placeholder="Velocidad (ml/s)" class="p-3 border rounded-lg touch-btn" />
          <input name="ritmo" placeholder="Ritmo durante estudio" class="p-3 border rounded-lg touch-btn" />
        </div>
      </section>

      <!-- Sección: Arterias coronarias (repeatable) -->
      <section id="arteriesSection" class="card p-3 border rounded-lg">
        <h2 class="font-medium text-lg mb-2">Arterias coronarias (toque para editar)</h2>
        <p class="text-sm text-slate-600 mb-2">Cada tarjeta corresponde a un vaso. Selecciona estenosis y plantillas para autocompletar comentarios.</p>
        <div id="arteriesContainer" class="space-y-3">
          <!-- Artery cards inserted here by JS -->
        </div>
      </section>

      <!-- Sección: Conclusiones y CAD-RADS -->
      <section class="card p-3 border rounded-lg">
        <h2 class="font-medium text-lg mb-2">Conclusiones</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <textarea name="conclusion_general" placeholder="Conclusión general" class="p-3 border rounded-lg min-h-[80px]"></textarea>
          <div class="space-y-2">
            <label class="block text-sm font-medium">CAD-RADS calculado</label>
            <div id="cadRadsBadge" class="text-white font-semibold px-3 py-2 rounded-lg inline-block bg-slate-400">—</div>
            <div class="mt-2">
              <label class="block text-sm">Recomendaciones (editable)</label>
              <textarea name="recomendaciones" placeholder="Recomendaciones" class="p-3 border rounded-lg min-h-[80px]"></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- Campo de salida: Texto generado -->
      <section class="card p-3 border rounded-lg">
        <h2 class="font-medium text-lg mb-2">Texto generado (vista previa)</h2>
        <textarea id="generatedReport" class="w-full p-3 border rounded-lg min-h-[180px]" readonly></textarea>
      </section>
    </form>

    <footer class="text-sm text-slate-500 mt-3">
      <p>Nota: el cálculo CAD-RADS implementado corresponde a una regla de decisión basada en CAD-RADS 2.0 (usar como apoyo, confirmar según protocolo local y contexto clínico). Referencias: CAD-RADS 2.0 y guías SCCT.</p>
    </footer>
  </div>

  <script>
    // ---------- Config / plantillas y mapeos CAD-RADS ----------
    // Plantillas de comentarios por categoría — personalizables
    const commentTemplates = {
      "none": "No se evidencia ateromatosis ni estenosis en este segmento.",
      "minimal": "Ateroma no obstructivo, lesiones mínimas sin compromiso luminal significativo.",
      "mild": "Placa no obstructiva con estenosis leve (25-49%). Control de factores de riesgo recomendado.",
      "moderate": "Estenosis moderada (50-69%). Correlacionar con clínica y considerar evaluación funcional.",
      "severe": "Estenosis severa (70-99%). Considerar intervención o pruebas funcionales según contexto.",
      "occluded": "Oclusión completa (100%). Correlacionar con hallazgos clínicos y planificar manejo."
    };

    // Mapeo simple de % -> CAD-RADS (regla práctica; confirmar con guías)
    function stenosisToCadRads(pct) {
      // pct: integer 0..100
      if (pct === 0) return "0";
      if (pct > 0 && pct <= 24) return "1";
      if (pct >= 25 && pct <= 49) return "2";
      if (pct >= 50 && pct <= 69) return "3";
      if (pct >= 70 && pct <= 99) return "4";
      if (pct === 100) return "5";
      return "?";
    }

    // Se usa el mayor % de obstrucción para definir el CAD-RADS
    function calculateGlobalCadRads(arteries) {
      let worst = 0;
      arteries.forEach(a => {
        const v = parseInt(a.porcentaje_obstruccion || 0);
        if (!isNaN(v) && v > worst) worst = v;
      });
      return stenosisToCadRads(worst);
    }

    // ---------- UI dinámico: agregar tarjeta de arteria ----------
    let arteryIdCounter = 0;
    const arteriesContainer = document.getElementById('arteriesContainer');
    const generatedReport = document.getElementById('generatedReport');
    const cadRadsBadge = document.getElementById('cadRadsBadge');

    function createArteryCard(data = {}) {
      const id = ++arteryIdCounter;
      const card = document.createElement('div');
      card.className = "p-3 border rounded-lg bg-slate-50 card touchable";
      card.dataset.id = id;
      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div>
            <input data-key="nombre_vaso" placeholder="Nombre vaso (ej. ADA - segmento proximal)" class="p-3 border rounded-lg w-full touch-btn mb-2" value="${data.nombre_vaso||''}" />
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <select data-key="segmento" class="p-3 border rounded-lg touch-btn">
                <option value="">Segmento</option>
                <option>Proximal</option>
                <option>Medio</option>
                <option>Distal</option>
              </select>
              <select data-key="calibre" class="p-3 border rounded-lg touch-btn">
                <option value="">Calibre y desarrollo</option>
                <option>Bueno</option>
                <option>Pequeño</option>
                <option>Hipertrofiado</option>
              </select>
              <select data-key="ateromatosis" class="p-3 border rounded-lg touch-btn">
                <option value="">Ateromatosis</option>
                <option>No</option>
                <option>Calcificada</option>
                <option>Mista</option>
                <option>No calcificada</option>
              </select>
            </div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <label class="text-xs text-slate-600">Obstrucción (%)</label>
            <input data-key="porcentaje_obstruccion" type="range" min="0" max="100" value="${data.porcentaje_obstruccion||0}" class="touch-btn" />
            <div class="text-sm font-medium" data-key-display>0%</div>
            <div class="flex gap-2 mt-2">
              <button data-action="applyTemplate" class="bg-slate-200 rounded-lg px-3 py-2 touch-btn">Plantilla</button>
              <button data-action="remove" class="bg-red-500 text-white rounded-lg px-3 py-2 touch-btn">Quitar</button>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <label class="block text-sm">Comentario (editable)</label>
          <textarea data-key="comentario" class="p-2 border rounded-lg w-full min-h-[80px]">${data.comentario || ''}</textarea>
        </div>
      `;

      // append and wire events
      arteriesContainer.appendChild(card);

      // elements
      const range = card.querySelector('input[type="range"]');
      const percentDisplay = card.querySelector('[data-key-display]');
      const textarea = card.querySelector('textarea[data-key="comentario"]');
      const applyBtn = card.querySelector('button[data-action="applyTemplate"]');
      const removeBtn = card.querySelector('button[data-action="remove"]');

      // live display of percent
      function updatePercent() {
        percentDisplay.textContent = `${range.value}%`;
        computeAll(); // update CAD-RADS and preview
      }
      range.addEventListener('input', updatePercent);
      updatePercent();

      // plantillas: muestra un menú simple con opciones táctiles (usamos prompt para simplicidad)
      applyBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // Lista táctil: prompt con números grandes
        const options = [
          {k:'none', t:'Sin lesiones (0%)'},
          {k:'minimal', t:'Ateroma mínimo (1-24%)'},
          {k:'mild', t:'Lesión leve (25-49%)'},
          {k:'moderate', t:'Estenosis moderada (50-69%)'},
          {k:'severe', t:'Estenosis severa (70-99%)'},
          {k:'occluded', t:'Oclusión (100%)'}
        ];
        // Build choice string
        const choiceStr = options.map((o,i)=> `${i+1}) ${o.t}`).join('\\n');
        const sel = prompt("Seleccione plantilla:\\n\\n" + choiceStr + "\\n\\nEscriba el número (ej. 1)", "1");
        const n = parseInt(sel);
        if (!isNaN(n) && n>=1 && n<=options.length) {
          const key = options[n-1].k;
          textarea.value = commentTemplates[key] || '';
          // optionally set the range according to template
          const mapPct = {none:0, minimal:10, mild:35, moderate:60, severe:85, occluded:100};
          range.value = mapPct[key];
          updatePercent();
          computeAll();
        }
      });

      // quitar tarjeta
      removeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (confirm('Quitar este vaso?')) {
          card.remove();
          computeAll();
        }
      });

      // fill selects if data provided
      ['segmento','calibre','ateromatosis'].forEach(name => {
        if (data[name]) {
          const el = card.querySelector(`[data-key="${name}"]`);
          if (el) el.value = data[name];
        }
      });

      return card;
    }

    // Inicial: añade 3 arterias comunes
    function addDefaultArteries() {
      createArteryCard({nombre_vaso:'Tronco coronario izquierdo', porcentaje_obstruccion:0, comentario: commentTemplates.none});
      createArteryCard({nombre_vaso:'Arteria Descendente Anterior (ADA) - proximal', porcentaje_obstruccion:0, comentario: commentTemplates.none});
      createArteryCard({nombre_vaso:'Arteria Coronaria Derecha - proximal', porcentaje_obstruccion:0, comentario: commentTemplates.none});
    }

    // Recolectar datos del formulario y arterias
    function collectData() {
      const form = document.getElementById('angioForm');
      const formData = new FormData(form);
      const base = {};
      for (const [k,v] of formData.entries()) base[k]=v;
      // arteries
      const cards = [...arteriesContainer.children];
      const arteries = cards.map(card => {
        const get = (key) => {
          const el = card.querySelector(`[data-key="${key}"]`);
          if (!el) return '';
          if (el.tagName === 'INPUT' && el.type === 'range') return el.value;
          return el.value || '';
        };
        return {
          nombre_vaso: get('nombre_vaso'),
          segmento: get('segmento'),
          calibre: get('calibre'),
          ateromatosis: get('ateromatosis'),
          porcentaje_obstruccion: parseInt(get('porcentaje_obstruccion')||0),
          comentario: card.querySelector('[data-key="comentario"]').value || ''
        };
      });
      return {base, arteries};
    }

    // Generar texto automático (plantillas combinadas)
    function buildReportText(data) {
      const {base, arteries} = data;
      const lines = [];
      lines.push(`Reporte AngioTC Cardiaco`);
      if (base.nombre) lines.push(`Nombre: ${base.nombre}`);
      if (base.identificacion) lines.push(`Identificación: ${base.identificacion}`);
      if (base.fecha_estudio) lines.push(`Fecha del estudio: ${base.fecha_estudio}`);
      lines.push('');
      lines.push('Datos técnicos:');
      if (base.tomografo) lines.push(`Tomógrafo: ${base.tomografo}`);
      if (base.ecg_gating) lines.push(`ECG-gating: ${base.ecg_gating}`);
      lines.push('');
      lines.push('Arterias coronarias:');
      arteries.forEach(a => {
        lines.push(`- ${a.nombre_vaso || '(sin nombre)'} | Segmento: ${a.segmento || '-'} | Estenosis: ${a.porcentaje_obstruccion || 0}%`);
        if (a.comentario) lines.push(`  Comentario: ${a.comentario}`);
      });
      lines.push('');
      const cad = calculateGlobalCadRads(arteries);
      lines.push(`CAD-RADS calculado (según mayor estenosis): ${cad}`);
      if (base.conclusion_general) {
        lines.push('');
        lines.push('Conclusión general:');
        lines.push(base.conclusion_general);
      }
      if (base.recomendaciones) {
        lines.push('');
        lines.push('Recomendaciones:');
        lines.push(base.recomendaciones);
      }
      return lines.join('\\n');
    }

    // Compute all: update preview and CAD-RADS badge
    function computeAll() {
      const data = collectData();
      const cad = calculateGlobalCadRads(data.arteries);
      cadRadsBadge.textContent = cad;
      // Set badge color by severity
      const mapColor = { "0": "bg-green-600", "1":"bg-emerald-600", "2":"bg-yellow-500", "3":"bg-orange-500", "4":"bg-red-600", "5":"bg-red-800" };
      cadRadsBadge.className = "text-white font-semibold px-3 py-2 rounded-lg inline-block " + (mapColor[cad]||'bg-slate-400');
      generatedReport.value = buildReportText(data);
    }

    // handlers for add artery, preload, generate pdf, reset
    document.getElementById('btnAddArtery').addEventListener('click', (e)=> {
      e.preventDefault();
      createArteryCard();
      computeAll();
      window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
    });

    // Precarga: ejemplos (usa escenarios realistas: normal, placa no obstructiva, estenosis moderada)
    document.getElementById('btnPreload').addEventListener('click', (e) => {
      e.preventDefault();
      // reset first
      arteriesContainer.innerHTML = '';
      arteryIdCounter = 0;
      // Example scenario: paciente con estenosis moderada en RCA proximal
      createArteryCard({nombre_vaso:'Tronco coronario izquierdo', porcentaje_obstruccion:0, comentario: commentTemplates.none});
      createArteryCard({nombre_vaso:'ADA - proximal', porcentaje_obstruccion:10, comentario: commentTemplates.minimal});
      createArteryCard({nombre_vaso:'ACX - medio', porcentaje_obstruccion:0, comentario: commentTemplates.none});
      createArteryCard({nombre_vaso:'RCA - proximal', porcentaje_obstruccion:55, comentario: commentTemplates.moderate});
      // fill patient base fields
      const f = document.querySelector('form#angioForm');
      f.nombre.value = "Ejemplo Paciente";
      f.identificacion.value = "12345678";
      f.fecha_estudio.value = new Date().toISOString().slice(0,10);
      f.tomografo.value = "Canon Aquilion 160";
      f.ecg_gating.value = "Retrospectivo";
      f.conclusion_general.value = "Ventrículo izquierdo con FEVI normal. Hallazgos descritos en arterias.";
      f.recomendaciones.value = "Control de factores de riesgo; considerar prueba funcional para estenosis moderada de RCA.";
      computeAll();
    });

    // Generar PDF con jsPDF
    document.getElementById('btnGenerate').addEventListener('click', async (e) => {
      e.preventDefault();
      computeAll();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const title = 'Reporte AngioTC Cardiaco';
      doc.setFontSize(14);
      doc.text(title, 40, 50);
      doc.setFontSize(10);
      // put the generated text (wrap)
      const text = generatedReport.value || 'Sin contenido';
      const split = doc.splitTextToSize(text, 500);
      doc.text(split, 40, 80);
      // Footer
      doc.setFontSize(8);
      doc.text('Generado con formulario dinámico — revisar y firmar según protocolo local', 40, 780);
      // Save
      doc.save(`Reporte_AngioTC_${(new Date()).toISOString().slice(0,10)}.pdf`);
    });

    // Reset
    document.getElementById('btnReset').addEventListener('click', (e) => {
      e.preventDefault();
      if (!confirm('Desea reiniciar el formulario?')) return;
      document.getElementById('angioForm').reset();
      arteriesContainer.innerHTML = '';
      arteryIdCounter = 0;
      addDefaultArteries();
      computeAll();
    });

    // Observe changes in form to recompute
    document.getElementById('angioForm').addEventListener('input', () => computeAll());

    // Inicializar UI
    addDefaultArteries();
    computeAll();
  </script>
</body>
</html>

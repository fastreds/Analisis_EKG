<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reporte Angio-TAC Cardiaco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        .form-section {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .preview-section {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            min-height: 500px;
            font-size: 14px;
            line-height: 1.6;
        }

        .cad-rads-display {
            font-weight: bold;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin-top: 16px;
            transition: all 0.3s ease;
            font-size: 1.25rem;
        }

        .plaque-group {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .btn-add {
            background-color: #10b981;
            color: white;
        }

        .btn-remove {
            background-color: #ef4444;
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>

<body class="p-4 md:p-8">

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Confirmación</h3>
            <p id="modal-message" class="mb-6">¿Estás seguro?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm"
                    class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">Sí</button>
                <button id="modal-cancel"
                    class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">No</button>
            </div>
        </div>
    </div>

    <div id="custom-alert" class="modal-overlay">
        <div class="modal-content">
            <h3 id="alert-title" class="text-lg font-bold mb-4">Aviso</h3>
            <p id="alert-message" class="mb-6"></p>
            <button id="alert-ok"
                class="bg-blue-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-600">OK</button>
        </div>
    </div>


    <div class="max-w-screen-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">REPORTE DE TOMOGRAFÍA COMPUTARIZADA CARDIACA
                CON MULTIDETECTORES
            </h1>
            <p class="text-gray-600 mt-2 text-lg">Incluye análisis de calcio y CAD-RADS.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <div class="flex space-x-4 mb-4">
                    <button id="preload-normal-btn"
                        class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors shadow-md">Cargar
                        Escenario Normal</button>
                    <button id="preload-severe-btn"
                        class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-md">Cargar
                        Escenario Severo</button>
                </div>
                <div id="form-container"></div>
            </div>

            <div class="sticky top-8 self-start">
                <div class="form-section">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-700">Vista Previa del Informe</h2>
                    <div id="preview-container"
                        class="preview-section prose max-w-none prose-headings:text-gray-800 prose-p:my-1 prose-strong:text-gray-700">
                        <p class="text-gray-500">La vista previa del informe aparecerá aquí...</p>
                    </div>

                    <div id="cad-rads-result">
                        <h3 class="text-xl font-bold mt-6">Clasificación CAD-RADS™ 2.0</h3>
                        <div id="cad-rads-display" class="cad-rads-display bg-gray-200 text-gray-800">
                            Aún no calculado
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button id="save-btn"
                            class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-md">Guardar
                            Progreso</button>
                        <button id="clear-btn"
                            class="bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">Limpiar
                            Formulario</button>
                    </div>
                    <button id="generate-pdf-btn"
                        class="w-full mt-4 bg-purple-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-purple-700 transition-colors text-lg shadow-lg">Generar
                        PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const reportStructure = [
            {
                title: "Datos del Paciente",
                id: "datos_paciente",
                fields: [
                    { id: 'nombre', label: 'Nombre', type: 'text', placeholder: 'Nombre completo del paciente' },
                    { id: 'id_paciente', label: 'Identificación', type: 'text', placeholder: 'Cédula o ID' },
                    { id: 'edad', label: 'Edad', type: 'number', placeholder: 'Años' },
                    { id: 'genero', label: 'Género', type: 'select', options: ['Masculino', 'Femenino', 'Otro'] },
                    { id: 'fecha_estudio', label: 'Fecha del Estudio', type: 'date' },
                    { id: 'medico_referente', label: 'Médico Referente', type: 'text', placeholder: 'Dr(a). Apellido' }
                ]
            },


            //////////////////////////////////  EDITAR DESDE AQUÍ  ///////////////////////////////////////

    {
        "title": "Información Clínica",
        "id": "informacion_clinica",
        "fields": [
            { "id": "indicacion", "label": "Indicación del Estudio", "type": "textarea", "placeholder": "Ej: Dolor torácico atípico, evaluación de riesgo cardiovascular...", "rows": 3 },
            { "id": "factores_riesgo", "label": "Factores de Riesgo Cardiovascular", "type": "checkbox", "options": ["Hipertensión arterial", "Diabetes mellitus", "Dislipidemia", "Tabaquismo", "Historia familiar de enfermedad coronaria", "Obesidad", "Sedentarismo"] }
        ]
    },
    {
        "title": "Protocolo del Estudio",
        "id": "protocolo_estudio",
        "fields": [
            { "id": "equipo", "label": "Equipo", "type": "select", "options": ["Tomógrafo Aquilion ONE 320-detectores", "Otro Tomógrafo Multidetector"] },
            { "id": "adquisicion", "label": "Tipo de Adquisición", "type": "select", "options": ["Gating cardiaco retrospectivo", "Gating cardiaco prospectivo"] },
            { "id": "contraste_iv", "label": "Contraste Intravenoso", "type": "text", "placeholder": "Ej: 80 ml de Ultravist 370" },
            { "id": "calidad_imagen", "label": "Calidad de la Imagen", "type": "select", "options": ["Excelente", "Buena", "Diagnóstica", "Limitada por artefactos", "No diagnóstica"] }
        ]
    },
    {
        "title": "Métodos del Estudio",
        "id": "metodos_estudio",
        "fields": [
            { "id": "tomografo", "label": "Tomógrafo", "type": "select", "options": ["Canon Aquilion 160 cortes", "Siemens Somatom", "GE Revolution", "Philips Ingenuity", "Canon Aquilion ONE 320"] },
            { "id": "tiempo_rotacion", "label": "Tiempo de rotación", "type": "select", "options": ["0.28/seg", "0.35/seg", "0.5/seg", "0.7/seg"] },
            { "id": "ecg_gating", "label": "ECG-gating para Corazón y Aorta torácica", "type": "select", "options": ["Retrospectivo", "Prospectivo", "Sin ECG"] },
            { "id": "ecg_gating_detalles", "label": "Detalles de ECG-gating", "type": "text", "placeholder": "Ej: variabilidad FC respiratoria marcada" },
            { "id": "medio_contraste", "label": "Medio contraste", "type": "select", "options": ["Ultravist 370", "Omnipaque 350", "Visipaque 320", "Optiray 350", "Isovue 370"] },
            { "id": "volumen_contraste", "label": "Volumen de medio contraste", "type": "text", "placeholder": "Ej: 85 ml" },
            { "id": "velocidad_infusion", "label": "Velocidad de infusión de medio contraste", "type": "select", "options": ["4 ml/s", "5 ml/s", "6 ml/s"] },
            { "id": "ritmo_estudio", "label": "Ritmo durante el estudio", "type": "select", "options": ["Ritmo sinusal normal", "Ritmo bradicardia sinusal", "Taquicardia sinusal", "Fibrilación auricular"] }
        ]
    },
    {
        "title": "Motivo de estudio y generalidades",
        "id": "motivo_generalidades",
        "fields": [
            { "id": "descripcion_referencia", "label": "DESCRIPCIÓN DE LA REFERENCIA", "type": "textarea", "rows": 3 },
            { "id": "consentimiento_informado", "label": "Consentimiento informado", "type": "textarea", "placeholder": "Después de explicar al paciente los riesgos potenciales y los beneficios que obtendrá del estudio y siguiendo en todo momento los principios éticos respectivos y normados, se firma el consentimiento informado para realizar el estudio.", "rows": 3 },
            { "id": "tolerancia_estudio", "label": "Tolerancia al estudio", "type": "select", "options": ["Buena tolerancia, sin reacciones adversas al medio contraste", "Reacciones leves (urticaria, náuseas)", "Reacciones moderadas (vómitos, broncoespasmo)", "Reacciones severas (anafilaxia)"] },
            { "id": "fc_durante_estudio", "label": "FC durante el estudio", "type": "text", "placeholder": "Ej: 45-55 lpm" },
            { "id": "medicamentos_usados", "label": "Medicamentos usados", "type": "checkbox", "options": ["Nitroglicerina sublingual", "Beta-bloqueadores"] },
            { "id": "analisis_imagenes", "label": "Análisis de imágenes", "type": "select", "options": ["Vitrea", "Syngo.via", "IntelliSpace Portal", "Circle CVI", "Medis Suite", "CardIQ"] }
        ]
    },
    {
        "title": "Anatomía cardiovascular",
        "id": "anatomia_cardiovascular",
        "fields": [
            { "id": "venas_cavas", "label": "Venas cavas", "type": "select", "options": ["Ambas no dilatadas drenando en la aurícula derecha", "Dilatada superior o inferior", "Azygos continuation of IVC", "Persistent left SVC draining to coronary sinus", "Thrombus", "Stenosis o compresión"] },
            { "id": "auricula_derecha", "label": "Aurícula derecha", "type": "select", "options": ["No dilatada", "Dilatada", "Thrombus", "Myxoma o masa", "Hipertrofia"] },
            { "id": "septum_interauricular", "label": "Septum interauricular", "type": "select", "options": ["No se visualizan defectos", "Defecto septal atrial", "Patent foramen ovale", "Aneurisma septal", "Hipertrofia lipomatosa"] },
            { "id": "seno_coronario", "label": "Seno coronario", "type": "select", "options": ["Drenando a la AD en forma habitual sin dilatación o anomalías", "Dilatado", "Drenaje anómalo", "Obstrucción o compresión"] },
            { "id": "valvula_tricuspide", "label": "Válvula tricúspide", "type": "select", "options": ["No se visualizan defectos por este método", "Regurgitación funcional", "Estenosis", "Vegetaciones", "Calcificación"] },
            { "id": "ventriculo_derecho", "label": "Ventrículo derecho", "type": "select", "options": ["No dilatado ni hipertrófico", "Dilatado", "Hipertrófico", "Disfunción o hipocinesia", "Infiltración adiposa", "Thrombus"] },
            { "id": "arteria_pulmonar", "label": "Arteria pulmonar", "type": "select", "options": ["Diámetro Normal", "Dilatada (>34 mm)", "Estenosis", "Tromboembolismo", "Aneurisma"] },
            { "id": "venas_pulmonares", "label": "Venas pulmonares", "type": "select", "options": ["Cuatro drenando a la aurícula izquierda, dos derechas y dos izquierdas", "Drenaje anómalo (PAPVR/TAPVR)", "Estenosis u oclusión", "Dilatadas", "Síndrome de Scimitar"] },
            { "id": "auricula_izquierda", "label": "Aurícula izquierda", "type": "select", "options": ["No se observan trombos en la orejuela izquierda, ni masas o lesiones intracardiacas", "Dilatada", "Thrombus en orejuela", "Myxoma o masa", "Cor triatriatum"] },
            { "id": "ventriculo_izquierdo_size", "label": "Tamaño Ventrículo izquierdo", "type": "select", "options": ["No dilatado", "Dilatado"] },
            { "id": "ventriculo_izquierdo_hipertrofia", "label": "Hipertrofia Ventrículo izquierdo", "type": "select", "options": ["Ninguna", "Concéntrica leve", "Concéntrica moderada", "Concéntrica severa", "Excéntrica", "Asimétrica"] },
            { "id": "ventriculo_izquierdo_motilidad", "label": "Motilidad Ventrículo izquierdo", "type": "select", "options": ["Global y regional conservada", "Hipocinesia global", "Hipocinesia regional", "Acinesia"] },
            { "id": "ventriculo_izquierdo_fevi", "label": "FEVI Ventrículo izquierdo", "type": "select", "options": ["Normal (>55%)", "Levemente reducida (45-54%)", "Moderadamente reducida (30-44%)", "Severamente reducida (<30%)"] },
            { "id": "hallazgos_extracardiacos", "label": "Hallazgos extracardiacos", "type": "select", "options": ["Ninguno", "Hernia hiatal pequeña", "Calcificaciones aórticas", "Lesiones pulmonares", "Dilatación aórtica", "Otras anomalías torácicas"] }
        ]
    },
    {
        "title": "Válvula Aórtica y Diámetros de la Aorta",
        "id": "valvula_aortica_diametros_aorta",
        "fields": [
            { "id": "cuspidies", "label": "Cúspides", "type": "select", "options": ["3 cúspides de conformación Normal", "2 cúspides (bicúspide R-L)", "2 cúspides (bicúspide R-N)", "2 cúspides (bicúspide L-N)", "4 cúspides (quadricúspide)", "1 cúspide (unicúspide)", "3 cúspides con fusión parcial", "3 cúspides con desigualdad en tamaño", "Cúspides izquierda coronaria, derecha coronaria y no coronaria", "Cúspides izquierda, derecha y posterior", "Variaciones menores en tamaño de cúspides"] },
            { "id": "calcificaciones", "label": "Calcificaciones", "type": "select", "options": ["NO PRESENTA", "Leve (<400 AU)", "Moderada (400-1300 AU en mujeres, 1000-2000 AU en hombres)", "Severa (>1300 AU en mujeres, >2000 AU en hombres)", "Pesada (sugiere estenosis severa)", "Calcificación asociada a regurgitación", "Calcificación en cúspides individuales", "Calcificación anular", "Calcificación extendida a raíz aórtica", "Ninguna visible por método"] },
            { "id": "morfologia_anillo", "label": "Morfología del Anillo aórtico", "type": "select", "options": ["Elíptica", "Circular", "Oval", "Asimétrica", "Coroniforme", "Diamante", "Triangular", "Irregular", "Cambios conformacionales durante ciclo cardíaco", "Más circular en <40 años", "Más oval en >40 años", "Vertical u horizontal"] },
            { "id": "diametro_menor_anillo", "label": "Diámetro menor del anillo (mm)", "type": "select", "options": ["15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40"] },
            { "id": "diametro_mayor_anillo", "label": "Diámetro mayor del anillo (mm)", "type": "select", "options": ["15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40"] },
            { "id": "senos_valsalva_diametro", "label": "Diámetro Senos de Valsalva (mm)", "type": "select", "options": ["20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50"] },
            { "id": "senos_valsalva_indexado", "label": "Diámetro indexado Senos de Valsalva (mm/m2 SC)", "type": "select", "options": ["10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30"] },
            { "id": "senos_valsalva_referencia", "label": "Valores de referencia Indexados Senos de Valsalva (mm/m2 SC)", "type": "select", "options": ["16±2 (15-18)", "14±2 (13-15)", "18±2 (17-19)", "30.51 mm/m2 promedio", "<20 mm/m2 normal", "22.77 mm/m2 annulus", "15-18", "13-17", "28.2 ± 3.2"] },
            { "id": "senos_valsalva_aneurismatico", "label": "Referencia de rango aneurismático Senos de Valsalva (mm/m2 SC)", "type": "select", "options": ["24", "21", "25", ">2.1 cm/m2", ">2.75 cm/m2", ">2.9 cm/m2", "4.5-5.0 cm", ">40 mm absoluto"] },
            { "id": "senos_valsalva_observaciones", "label": "Observaciones Senos de Valsalva", "type": "select", "options": ["NORMAL", "DILATADO", "ANEURISMÁTICO", "CALCIFICADO", "ECTASIA", "SINUSOIDAL", "MAYOR EN HOMBRES", "MENOR EN MUJERES", "RELACIONADO CON EDAD", "SIN CAMBIOS"] },
            { "id": "union_sinotubular_diametro", "label": "Diámetro Unión sinotubular (mm)", "type": "select", "options": ["20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45"] },
            { "id": "union_sinotubular_indexado", "label": "Diámetro indexado Unión sinotubular (mm/m2 SC)", "type": "select", "options": ["10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25"] },
            { "id": "union_sinotubular_referencia", "label": "Valores de referencia Indexados Unión sinotubular (mm/m2 SC)", "type": "select", "options": ["14±2 (13-15)", "13±2", "15±2", "28.2 ± 3.2", "<30 mm absoluto", "14-17", "21.6 ± 1.6 basal", "35.1 ± 4.8 STJ"] },
            { "id": "union_sinotubular_aneurismatico", "label": "Referencia de rango aneurismático Unión sinotubular (mm/m2 SC)", "type": "select", "options": ["21", "24", "25", ">2.1 cm/m2", ">2.75 cm/m2", ">40 mm", ">5.0 cm"] },
            { "id": "union_sinotubular_observaciones", "label": "Observaciones Unión sinotubular", "type": "select", "options": ["NORMAL", "DILATADO", "ANEURISMÁTICO", "FUNCIONALMENTE DILATADO >30 mm", "RELACIONADO CON BSA", "SIN DILATACIÓN", "MAYOR EN ATLETAS", "MENOR EN MUJERES"] },
            { "id": "porcion_tubular_ascendente_diametro", "label": "Diámetro Porción tubular ascendente (mm)", "type": "select", "options": ["20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50"] },
            { "id": "porcion_tubular_ascendente_indexado", "label": "Diámetro indexado Porción tubular ascendente (mm/m2 SC)", "type": "select", "options": ["10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28"] },
            { "id": "porcion_tubular_ascendente_referencia", "label": "Valores de referencia Indexados Porción tubular ascendente (mm/m2 SC)", "type": "select", "options": ["14±2 (13-17)", "13±2", "17±2", "28.30 mm/m2 promedio", "<2.1 cm/m2", "<40 mm absoluto", "33 ± 4 mm", "3.0 cm ± 0.5"] },
            { "id": "porcion_tubular_ascendente_aneurismatico", "label": "Referencia de rango aneurismático Porción tubular ascendente (mm/m2 SC)", "type": "select", "options": ["24", "21", "25", ">2.1 cm/m2", ">4 cm absoluto", ">4.5 cm", ">5.0 cm", ">2.75 cm/m2"] },
            { "id": "porcion_tubular_ascendente_observaciones", "label": "Observaciones Porción tubular ascendente", "type": "select", "options": ["NORMAL", "DILATADO (>35 mm)", "ANEURISMÁTICO (>45 mm)", "MEDICIÓN A 40 MM DEL ANILLO", "SIN DILATACIÓN", "RELACIONADO CON EDAD Y SEXO", "MAYOR EN HOMBRES", "ECTASIA", "DISSECCIÓN POSIBLE"] }
        ]
    },

            
            //// FINALIZA EDICIÓN AQUÍ ///////////////////////////////////////////////////////////////////////////////////
            {
                title: "Score de Calcio (Agatston)",
                id: "score_calcio",
                fields: [
                    { id: 'tci', label: 'TCI', type: 'number', placeholder: '0', class: 'score-input' },
                    { id: 'da', label: 'DA', type: 'number', placeholder: '0', class: 'score-input' },
                    { id: 'cx', label: 'CX', type: 'number', placeholder: '0', class: 'score-input' },
                    { id: 'cd', label: 'CD', type: 'number', placeholder: '0', class: 'score-input' },
                    { id: 'total', label: 'Score Total', type: 'number', placeholder: 'Calculado', readonly: true },
                    { id: 'percentil', label: 'Percentil para Edad y Género', type: 'select', options: ['<25', '25-50', '50-75', '>75', '>90'] }
                ]
            },
            {
                title: "Arterias Coronarias",
                type: "repeatableGroup",
                id: "arterias_coronarias",
                template: [
                    { id: 'nombre', label: 'Vaso Sanguíneo', type: 'text', readonly: true },
                    { id: 'dominancia', label: 'Dominancia', type: 'select', options: ['No aplica', 'Dominante', 'No dominante', 'Codominante'], condition: (item) => ['Arteria Coronaria Derecha (CD)', 'Arteria Circunfleja (CX)'].includes(item.nombre) },
                    { id: 'descripcion_general', label: 'Descripción General', type: 'select', options: ['Normal, sin evidencia de placa', 'Presenta placa ateromatosa', 'Anomalía de origen/trayecto', 'Ocluida crónicamente'] },
                ],
                plaqueTemplate: [
                    { id: 'tipo_placa', label: 'Tipo de Placa', type: 'select', options: ['No calcificada', 'Calcificada', 'Mixta (predominio no calcificado)', 'Mixta (predominio calcificado)'] },
                    { id: 'localizacion', label: 'Localización', type: 'select', options: ['Ostial', 'Proximal', 'Medio', 'Distal', 'Bifurcación'] },
                    { id: 'longitud', label: 'Longitud (mm)', type: 'number', placeholder: 'Ej: 10' },
                    { id: 'remodelado', label: 'Remodelado Vascular', type: 'select', options: ['No aplica', 'Positivo', 'Negativo', 'Ausente'] },
                    { id: 'estenosis_severidad', label: 'Severidad de Estenosis', type: 'select', options: ['Sin estenosis (0%)', 'Mínima (1-24%)', 'Leve (25-49%)', 'Moderada (50-69%)', 'Severa (70-99%)', 'Oclusión total (100%)'] },
                    { id: 'estenosis_porcentaje', label: '% Estenosis', type: 'number', placeholder: '0-100' }
                ],
                items: [
                    { nombre: 'Tronco Coronario Izquierdo (TCI)', placas: [] },
                    { nombre: 'Arteria Descendente Anterior (DA)', placas: [] },
                    { nombre: 'Arteria Circunfleja (CX)', placas: [] },
                    { nombre: 'Arteria Coronaria Derecha (CD)', placas: [] },
                    { nombre: 'Ramo Intermedio', placas: [] },
                    { nombre: 'Ramos Diagonales', placas: [] },
                    { nombre: 'Ramos Marginales Obtusos', placas: [] },
                    { nombre: 'Arteria Descendente Posterior (DP)', placas: [] },
                    { nombre: 'Ramos Posterolaterales (PL)', placas: [] }
                ]
            },
            {
                title: "Evaluación Extracardiaca",
                id: "evaluacion_extracardiaca",
                fields: [
                    { id: 'hallazgos', label: 'Hallazgos Significativos', type: 'checkbox', options: ['Sin hallazgos patológicos significativos', 'Aneurisma/dilatación de aorta torácica', 'Nódulos pulmonares', 'Embolismo pulmonar', 'Derrame pericárdico', 'Derrame pleural', 'Hernia hiatal', 'Linfadenopatías mediastinales'] }
                ]
            },
            {
                title: "Comentarios Adicionales",
                id: "comentarios_adicionales",
                fields: [{ id: 'texto', label: 'Comentarios', type: 'textarea', placeholder: 'Añadir cualquier comentario relevante no cubierto en otras secciones...', rows: 4 }]
            },
            {
                title: "Conclusión",
                id: "conclusion",
                fields: [{ id: 'texto_conclusion', label: 'Texto de la Conclusión', type: 'textarea', placeholder: 'La conclusión se generará automáticamente basada en los hallazgos...', rows: 8 }]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const formContainer = document.getElementById('form-container');
            const previewContainer = document.getElementById('preview-container');
            const cadRadsDisplay = document.getElementById('cad-rads-display');

            const showAlert = (message, title = 'Aviso') => {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').textContent = message;
                const alertModal = document.getElementById('custom-alert');
                alertModal.classList.add('visible');
                return new Promise(resolve => {
                    document.getElementById('alert-ok').onclick = () => {
                        alertModal.classList.remove('visible');
                        resolve(true);
                    };
                });
            };

            const showConfirm = (message, title = 'Confirmación') => {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                const modal = document.getElementById('custom-modal');
                modal.classList.add('visible');
                return new Promise(resolve => {
                    document.getElementById('modal-confirm').onclick = () => {
                        modal.classList.remove('visible');
                        resolve(true);
                    };
                    document.getElementById('modal-cancel').onclick = () => {
                        modal.classList.remove('visible');
                        resolve(false);
                    };
                });
            };

            function createField(field, prefix = '') {
                const container = document.createElement('div');
                container.className = 'mb-4';

                const label = document.createElement('label');
                label.className = 'block text-gray-700 font-semibold mb-2';
                label.setAttribute('for', prefix + field.id);
                label.textContent = field.label;

                if (field.type !== 'checkbox') container.appendChild(label);

                let input;
                const fieldId = prefix + field.id;

                switch (field.type) {
                    case 'select':
                        input = document.createElement('select');
                        field.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            input.appendChild(option);
                        });
                        break;
                    case 'textarea':
                        input = document.createElement('textarea');
                        input.rows = field.rows || 5;
                        break;
                    case 'checkbox':
                        container.className = 'mb-4';
                        const fieldset = document.createElement('fieldset');
                        const legend = document.createElement('legend');
                        legend.className = 'block text-gray-700 font-semibold mb-2';
                        legend.textContent = field.label;
                        fieldset.appendChild(legend);

                        field.options.forEach(opt => {
                            const checkboxContainer = document.createElement('div');
                            checkboxContainer.className = 'flex items-center mb-1';
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `${fieldId}_${opt.replace(/\s+/g, '')}`;
                            checkbox.name = fieldId;
                            checkbox.value = opt;
                            checkbox.className = 'h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500';

                            const checkboxLabel = document.createElement('label');
                            checkboxLabel.setAttribute('for', checkbox.id);
                            checkboxLabel.textContent = opt;
                            checkboxLabel.className = 'ml-2 block text-sm text-gray-900';

                            checkboxContainer.appendChild(checkbox);
                            checkboxContainer.appendChild(checkboxLabel);
                            fieldset.appendChild(checkboxContainer);
                        });
                        container.appendChild(fieldset);
                        return container;

                    default: // text, number, date
                        input = document.createElement('input');
                        input.type = field.type;
                        if (field.placeholder) input.placeholder = field.placeholder;
                        if (field.readonly) input.readOnly = true;
                }

                input.id = fieldId;
                input.name = fieldId;
                input.className = 'w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
                if (field.readonly) {
                    input.classList.add('bg-gray-100', 'cursor-not-allowed');
                }
                if (field.class) {
                    input.classList.add(...field.class.split(' '));
                }
                if (field.defaultValue) {
                    input.value = field.defaultValue;
                }
                container.appendChild(input);
                return container;
            }

            function renderForm() {
                formContainer.innerHTML = '';
                reportStructure.forEach(section => {
                    const sectionEl = document.createElement('div');
                    sectionEl.className = 'form-section';

                    const titleEl = document.createElement('h2');
                    titleEl.className = 'text-2xl font-bold mb-6 border-b pb-3 text-gray-800';
                    titleEl.textContent = section.title;
                    sectionEl.appendChild(titleEl);

                    if (section.fields) {
                        const grid = document.createElement('div');
                        if (section.id === 'score_calcio') {
                            grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-4';
                        } else {
                            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-6';
                        }

                        section.fields.forEach(field => {
                            grid.appendChild(createField(field));
                        });
                        sectionEl.appendChild(grid);
                    } else if (section.type === 'repeatableGroup') {
                        const groupContainer = document.createElement('div');
                        groupContainer.id = section.id;
                        section.items.forEach((item, index) => {
                            const itemGroup = document.createElement('div');
                            itemGroup.className = 'mb-6 p-4 border rounded-lg shadow-sm';
                            itemGroup.dataset.index = index;

                            // Renderizar los campos de plantilla; si existe un campo "nombre" lo rellenamos con item.nombre
                            section.template.forEach(fieldTemplate => {
                                if (fieldTemplate.condition && !fieldTemplate.condition(item)) return;
                                const fieldData = { ...fieldTemplate, id: `${fieldTemplate.id}` };
                                const fieldEl = createField(fieldData, `${section.id}_${index}_`);
                                itemGroup.appendChild(fieldEl);

                                // Si el campo representa el nombre del vaso, cargar el valor desde item.nombre y dejarlo readonly
                                const inputId = `${section.id}_${index}_${fieldTemplate.id}`;
                                if (fieldTemplate.id === 'nombre') {
                                    const inputEl = itemGroup.querySelector(`#${CSS.escape(inputId)}`);
                                    if (inputEl) {
                                        inputEl.value = item.nombre || '';
                                        inputEl.readOnly = true;
                                        inputEl.classList.add('bg-gray-100', 'cursor-not-allowed');
                                    }
                                }
                            });

                            const plaquesContainerId = `${section.id}_${index}_plaques_container`;
                            const plaquesContainer = document.createElement('div');
                            plaquesContainer.id = plaquesContainerId;
                            itemGroup.appendChild(plaquesContainer);

                            const addPlaqueBtn = document.createElement('button');
                            addPlaqueBtn.textContent = 'Añadir Placa';
                            addPlaqueBtn.type = 'button';
                            addPlaqueBtn.className = 'mt-2 py-2 px-4 rounded-md font-semibold text-sm btn-add';
                            addPlaqueBtn.onclick = () => addPlaque(section.id, index, section.plaqueTemplate);
                            itemGroup.appendChild(addPlaqueBtn);

                            groupContainer.appendChild(itemGroup);
                        });
                        sectionEl.appendChild(groupContainer);
                    }
                    formContainer.appendChild(sectionEl);
                });
            }

            function addPlaque(sectionId, itemIndex, plaqueTemplate) {
                const plaquesContainer = document.getElementById(`${sectionId}_${itemIndex}_plaques_container`);
                const plaqueIndex = plaquesContainer.children.length;

                const plaqueGroup = document.createElement('div');
                plaqueGroup.className = 'plaque-group relative';
                plaqueGroup.dataset.plaqueIndex = plaqueIndex;

                const title = document.createElement('h4');
                title.className = 'font-bold text-gray-700 mb-2';
                title.textContent = `Placa #${plaqueIndex + 1}`;
                plaqueGroup.appendChild(title);

                plaqueTemplate.forEach(fieldTemplate => {
                    const prefix = `${sectionId}_${itemIndex}_placa_${plaqueIndex}_`;
                    plaqueGroup.appendChild(createField(fieldTemplate, prefix));
                });

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'X';
                removeBtn.type = 'button';
                removeBtn.className = 'absolute top-2 right-2 h-7 w-7 rounded-full font-bold text-xs btn-remove';
                removeBtn.onclick = () => plaqueGroup.remove();
                plaqueGroup.appendChild(removeBtn);

                plaquesContainer.appendChild(plaqueGroup);
            }

            function getFormData() {
                const data = {};
                reportStructure.forEach(section => {
                    data[section.id] = {};
                    if (section.fields) {
                        section.fields.forEach(field => {
                            if (field.type === 'checkbox') {
                                data[section.id][field.id] = Array.from(document.querySelectorAll(`input[name="${field.id}"]:checked`)).map(el => el.value);
                            } else {
                                const el = document.getElementById(field.id);
                                if (el) data[section.id][field.id] = el.value;
                            }
                        });
                    } else if (section.type === 'repeatableGroup') {
                        data[section.id] = section.items.map((item, index) => {
                            const itemData = { nombre: item.nombre };
                            section.template.forEach(fieldTemplate => {
                                const el = document.getElementById(`${section.id}_${index}_${fieldTemplate.id}`);
                                if (el) itemData[fieldTemplate.id] = el.value;
                            });

                            itemData.plaques = [];
                            const plaquesContainer = document.getElementById(`${section.id}_${index}_plaques_container`);
                            plaquesContainer.querySelectorAll('.plaque-group').forEach(plaqueGroup => {
                                const plaqueData = {};
                                const plaqueIndex = plaqueGroup.dataset.plaqueIndex;
                                section.plaqueTemplate.forEach(fieldTemplate => {
                                    const el = document.getElementById(`${section.id}_${index}_placa_${plaqueIndex}_${fieldTemplate.id}`);
                                    if (el) plaqueData[fieldTemplate.id] = el.value;
                                });
                                itemData.plaques.push(plaqueData);
                            });
                            return itemData;
                        });
                    }
                });
                return data;
            }

            function loadData(data) {
                if (!data) return;
                reportStructure.forEach(section => {
                    const sectionData = data[section.id];
                    if (!sectionData) return;

                    if (section.fields) {
                        section.fields.forEach(field => {
                            if (field.type === 'checkbox') {
                                if (sectionData[field.id]) {
                                    sectionData[field.id].forEach(value => {
                                        const el = document.getElementById(`${field.id}_${value.replace(/\s+/g, '')}`);
                                        if (el) el.checked = true;
                                    });
                                }
                            } else {
                                const el = document.getElementById(field.id);
                                if (el && sectionData[field.id] !== undefined) el.value = sectionData[field.id];
                            }
                        });
                    } else if (section.type === 'repeatableGroup') {
                        sectionData.forEach((itemData, index) => {
                            section.template.forEach(fieldTemplate => {
                                const el = document.getElementById(`${section.id}_${index}_${fieldTemplate.id}`);
                                if (el && itemData[fieldTemplate.id] !== undefined) el.value = itemData[fieldTemplate.id];
                            });
                            itemData.plaques?.forEach(() => {
                                addPlaque(section.id, index, section.plaqueTemplate);
                            });
                            itemData.plaques?.forEach((plaqueData, plaqueIndex) => {
                                section.plaqueTemplate.forEach(fieldTemplate => {
                                    const el = document.getElementById(`${section.id}_${index}_placa_${plaqueIndex}_${fieldTemplate.id}`);
                                    if (el && plaqueData[fieldTemplate.id] !== undefined) el.value = plaqueData[fieldTemplate.id];
                                });
                            });
                        });
                    }
                });
                updateAll();
            }

            function updateAll() {
                const data = getFormData();
                updateScoreCalcio(data);
                const { cadRads, color } = calculateCadRads(data);
                updateCadRadsDisplay(cadRads, color);
                const conclusionsText = generateConclusions(data, cadRads);
                document.getElementById('texto_conclusion').value = conclusionsText;
                updatePreview(data, cadRads, conclusionsText);
            }

            function updateScoreCalcio(data) {
                const scores = data.score_calcio;
                const total = (parseInt(scores.tci || 0) + parseInt(scores.da || 0) + parseInt(scores.cx || 0) + parseInt(scores.cd || 0));
                const totalEl = document.getElementById('total');
                if (totalEl) totalEl.value = total;
            }

            function updatePreview(data, cadRads, conclusionsText) {
                let html = ``;
                const dp = data.datos_paciente;
                const ic = data.informacion_clinica;
                const pe = data.protocolo_estudio;
                const sc = data.score_calcio;

                html += `<h3>DATOS DEL PACIENTE</h3>`;
                html += `<p><strong>Nombre:</strong> ${dp.nombre || 'N/A'}<br>`;
                html += `<strong>ID:</strong> ${dp.id_paciente || 'N/A'}<br>`;
                html += `<strong>Edad:</strong> ${dp.edad || 'N/A'} años<br>`;
                html += `<strong>Fecha:</strong> ${dp.fecha_estudio || 'N/A'}</p>`;

                html += `<h3 class="mt-4">INFORMACIÓN CLÍNICA</h3>`;
                html += `<p><strong>Indicación:</strong> ${ic.indicacion || 'N/A'}<br>`;
                html += `<strong>Factores de Riesgo:</strong> ${ic.factores_riesgo?.join(', ') || 'Ninguno'}</p>`;

                html += `<h3 class="mt-4">PROTOCOLO</h3>`;
                html += `<p>${pe.equipo || 'N/A'}. Adquisición con ${pe.adquisicion || 'N/A'}. Se administró ${pe.contraste_iv || 'contraste intravenoso'}. Calidad de imagen: ${pe.calidad_imagen || 'N/A'}.</p>`;

                html += `<h3 class="mt-4">SCORE DE CALCIO</h3>`;
                html += `<p>Score de Agatston total: <strong>${sc.total || '0'}</strong>. Percentil para edad y género: <strong>${sc.percentil || 'N/A'}</strong>.</p>`;

                html += `<h3 class="mt-4">HALLAZGOS CORONARIOS</h3>`;
                if (data.arterias_coronarias) {
                    data.arterias_coronarias.forEach(arteria => {
                        if (arteria && (arteria.descripcion_general !== 'Normal, sin evidencia de placa' || (arteria.placas && arteria.placas.length > 0))) {
                            html += `<p><strong>${arteria.nombre}:</strong> ${arteria.descripcion_general}. `;
                            if (arteria.dominancia && arteria.dominancia !== 'No aplica') html += `Vaso ${arteria.dominancia.toLowerCase()}. `;

                            if (arteria.placas) {
                                arteria.placas.forEach((placa, i) => {
                                    html += `Se identifica placa ${i + 1} de tipo ${placa.tipo_placa?.toLowerCase()}, ${placa.localizacion?.toLowerCase()}, que causa estenosis ${placa.estenosis_severidad?.toLowerCase()} del <strong>${placa.estenosis_porcentaje || 0}%</strong>.`;
                                });
                            }
                            html += `</p>`;
                        }
                    });
                }

                html += `<h3 class="mt-4">HALLAZGOS EXTRACARDIACOS</h3>`;
                html += `<p>${data.evaluacion_extracardiaca.hallazgos?.join(', ') || 'Sin hallazgos.'}</p>`;

                html += `<h3 class="mt-4">CONCLUSIÓN</h3>`;
                html += `<p>${conclusionsText.replace(/\n/g, '<br>')}</p>`;

                html += `<h3 class="mt-4">CLASIFICACIÓN</h3><p><strong>${cadRads}</strong></p>`;

                previewContainer.innerHTML = html;
            }

            function calculateCadRads(data) {
                let maxStenosis = 0;
                let hasStent = false; // Placeholder, can be added to JSON
                let hasBypass = false; // Placeholder
                let isNonDiagnostic = data.protocolo_estudio && data.protocolo_estudio.calidad_imagen === 'No diagnóstica';

                if (isNonDiagnostic) return { cadRads: 'CAD-RADS N', color: 'bg-gray-500' };

                if (data.arterias_coronarias) {
                    data.arterias_coronarias.forEach(arteria => {
                        if (arteria && arteria.placas) {
                            arteria.placas.forEach(placa => {
                                const obstruction = parseInt(placa.estenosis_porcentaje || 0, 10);
                                if (obstruction > maxStenosis) {
                                    maxStenosis = obstruction;
                                }
                            });
                        }
                    });
                }

                let cadRads = 'CAD-RADS 0';
                let color = 'bg-green-500';

                if (maxStenosis >= 1 && maxStenosis <= 24) { cadRads = 'CAD-RADS 1'; color = 'bg-cyan-500'; }
                else if (maxStenosis >= 25 && maxStenosis <= 49) { cadRads = 'CAD-RADS 2'; color = 'bg-yellow-400'; }
                else if (maxStenosis >= 50 && maxStenosis <= 69) { cadRads = 'CAD-RADS 3'; color = 'bg-orange-500'; }
                else if (maxStenosis >= 70 && maxStenosis <= 99) { cadRads = 'CAD-RADS 4A'; color = 'bg-red-500'; }
                else if (maxStenosis === 100) { cadRads = 'CAD-RADS 5'; color = 'bg-red-700'; }

                // Modifiers can be added here, e.g., /S for stent, /B for bypass, /V for vulnerable plaque

                return { cadRads, color };
            }

            function updateCadRadsDisplay(cadRads, color) {
                cadRadsDisplay.textContent = cadRads;
                cadRadsDisplay.className = `cad-rads-display text-white ${color}`;
            }

            function generateConclusions(data, cadRads) {
                let text = `Estudio de Angio-TAC coronario de calidad ${data.protocolo_estudio.calidad_imagen?.toLowerCase()}.\n`;

                const sc = data.score_calcio;
                text += `Score de calcio de Agatston total de ${sc.total || 0}, que corresponde a un percentil ${sc.percentil || 'N/A'} para la edad y género del paciente.\n`;

                let findingsCount = 0;
                if (data.arterias_coronarias) {
                    data.arterias_coronarias.forEach(arteria => {
                        if (arteria && arteria.placas && arteria.placas.length > 0) {
                            findingsCount++;
                            text += `\n- ${arteria.nombre}: `;
                            arteria.placas.forEach((placa, i) => {
                                text += `Placa ${placa.tipo_placa?.toLowerCase()} en el segmento ${placa.localizacion?.toLowerCase()} que condiciona una estenosis ${placa.estenosis_severidad?.toLowerCase()} (${placa.estenosis_porcentaje || 0}%). `;
                            });
                        }
                    });
                }

                if (findingsCount === 0) {
                    text += `\nArterias coronarias sin evidencia de placas ateromatosas significativas.\n`;
                }

                text += `\nHallazgos extracardiacos: ${data.evaluacion_extracardiaca.hallazgos?.join(', ') || 'Sin hallazgos significativos'}.\n`;
                text += `\nImpresión Diagnóstica: ${cadRads}.`;

                return text;
            }

            function loadScenario(type) {
                const normalScenario = {
                    datos_paciente: { nombre: "Paciente Normal", edad: 55, genero: "Masculino" },
                    informacion_clinica: { indicacion: "Evaluación de riesgo bajo", factores_riesgo: [] },
                    protocolo_estudio: { calidad_imagen: 'Excelente' },
                    score_calcio: { tci: 0, da: 0, cx: 0, cd: 0, percentil: '<25' },
                    arterias_coronarias: reportStructure.find(s => s.id === 'arterias_coronarias').items.map(i => ({ nombre: i.nombre, descripcion_general: 'Normal, sin evidencia de placa', placas: [] })),
                    evaluacion_extracardiaca: { hallazgos: ['Sin hallazgos patológicos significativos'] }
                };
                const severeScenario = {
                    datos_paciente: { nombre: "Paciente Severo", edad: 68, genero: "Masculino" },
                    informacion_clinica: { indicacion: "Dolor torácico típico", factores_riesgo: ['Hipertensión arterial', 'Tabaquismo', 'Dislipidemia'] },
                    protocolo_estudio: { calidad_imagen: 'Buena' },
                    score_calcio: { tci: 50, da: 450, cx: 20, cd: 180, percentil: '>90' },
                    arterias_coronarias: [
                        { nombre: 'Tronco Coronario Izquierdo (TCI)', descripcion_general: 'Presenta placa ateromatosa', placas: [{ tipo_placa: 'Calcificada', localizacion: 'Ostial', estenosis_severidad: 'Leve (25-49%)', estenosis_porcentaje: '30' }] },
                        { nombre: 'Arteria Descendente Anterior (DA)', descripcion_general: 'Presenta placa ateromatosa', placas: [{ tipo_placa: 'Mixta (predominio calcificado)', localizacion: 'Proximal', estenosis_severidad: 'Severa (70-99%)', estenosis_porcentaje: '85' }] },
                        { nombre: 'Arteria Circunfleja (CX)', descripcion_general: 'Normal, sin evidencia de placa', placas: [] },
                        { nombre: 'Arteria Coronaria Derecha (CD)', descripcion_general: 'Presenta placa ateromatosa', placas: [{ tipo_placa: 'No calcificada', localizacion: 'Medio', estenosis_severidad: 'Moderada (50-69%)', estenosis_porcentaje: '60' }] },
                        ...reportStructure.find(s => s.id === 'arterias_coronarias').items.slice(4).map(i => ({ nombre: i.nombre, descripcion_general: 'Normal, sin evidencia de placa', placas: [] }))
                    ],
                    evaluacion_extracardiaca: { hallazgos: ['Aneurisma/dilatación de aorta torácica'] }
                };

                renderForm();
                const data = type === 'normal' ? normalScenario : severeScenario;
                loadData(data);
            }

            formContainer.addEventListener('input', updateAll);
            formContainer.addEventListener('change', updateAll);

            document.getElementById('preload-normal-btn').addEventListener('click', () => loadScenario('normal'));
            document.getElementById('preload-severe-btn').addEventListener('click', () => loadScenario('severe'));

            document.getElementById('save-btn').addEventListener('click', () => {
                localStorage.setItem('angioTacReportData', JSON.stringify(getFormData()));
                showAlert('Progreso guardado en el navegador.');
            });

            document.getElementById('clear-btn').addEventListener('click', async () => {
                const confirmed = await showConfirm('¿Estás seguro de que quieres limpiar todo el formulario? Se perderá el progreso no guardado.');
                if (confirmed) {
                    localStorage.removeItem('angioTacReportData');
                    renderForm();
                    updateAll();
                }
            });

            document.getElementById('generate-pdf-btn').addEventListener('click', () => {
                const element = document.getElementById('preview-container');
                const data = getFormData();
                const filename = `Reporte_AngioTAC_${data.datos_paciente.nombre.replace(/\s/g, '_') || 'paciente'}.pdf`;
                const opt = {
                    margin: 0.5,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(element).save();
            });

            renderForm();
            try {
                const savedData = localStorage.getItem('angioTacReportData');
                if (savedData) {
                    loadData(JSON.parse(savedData));
                } else {
                    updateAll();
                }
            } catch (error) {
                console.error("Error loading data from localStorage:", error);
                updateAll();
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Dinámico de Reporte AngioTC Cardiaco</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto max-w-4xl bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-center">Reporte de Tomografía Computarizada Cardiaca con Multidetector</h1>
        
        <!-- Botones de Precarga y Exportación -->
        <div class="flex justify-between mb-4">
            <button id="preload-normal" class="bg-blue-500 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-600">Precargar Normal</button>
            <button id="preload-severe" class="bg-red-500 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-red-600">Precargar Severo</button>
            <button id="generate-pdf" class="bg-green-500 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-green-600">Generar PDF</button>
        </div>
        
        <!-- Navegación con Pestañas -->
        <div class="tabs mb-4">
            <ul class="flex border-b"></ul>
        </div>
        
        <!-- Contenido de las Pestañas -->
        <div id="tab-contents" class="space-y-6"></div>
        
        <!-- Vista Previa del Reporte -->
        <div id="preview" class="border border-gray-300 p-4 mt-6 rounded-lg bg-white hidden"></div>
    </div>

    <script>
        // Estructura JSON proporcionada
        const reportStructure = {
            "reportStructure": {
                "sections": [
                    {
                        "title": "Datos del Paciente",
                        "fields": [
                            { "name": "nombre", "label": "Nombre", "type": "text" },
                            { "name": "identificacion", "label": "Identificación", "type": "text" },
                            { "name": "genero", "label": "Género", "type": "select", "options": ["MASCULINO", "FEMENINA"] },
                            { "name": "edad", "label": "Edad (Años)", "type": "number" },
                            { "name": "peso", "label": "Peso (Kg)", "type": "number" },
                            { "name": "talla", "label": "Talla (CM)", "type": "number" },
                            { "name": "area_sc", "label": "Área SC (m²)", "type": "number" },
                            { "name": "fecha_estudio", "label": "Fecha del Estudio", "type": "date" },
                            { "name": "medico_refiere", "label": "Médico que Refiere", "type": "text" }
                        ]
                    },
                    {
                        "title": "Métodos del Estudio",
                        "fields": [
                            { "name": "tomografo", "label": "Tomógrafo", "type": "text", "default": "Canon Aquilion® / 160 cortes" },
                            { "name": "tiempo_rotacion", "label": "Tiempo de Rotación", "type": "text", "default": "0.5/seg" },
                            { "name": "ecg_gating", "label": "ECG-gating", "type": "text", "default": "Retrospectivo (variabilidad FC respiratoria marcada)" },
                            { "name": "medio_contraste", "label": "Medio Contraste", "type": "text", "default": "Ultravist 370" },
                            { "name": "volumen_contraste", "label": "Volumen de Medio Contraste (ml)", "type": "number", "default": 85 },
                            { "name": "velocidad_infusion", "label": "Velocidad de Infusión (ml/s)", "type": "number", "default": 5 },
                            { "name": "ritmo_estudio", "label": "Ritmo durante el Estudio", "type": "text", "default": "Ritmo bradicardia sinusal" }
                        ]
                    },
                    {
                        "title": "Motivo de Estudio y Generalidades",
                        "fields": [
                            { "name": "motivo", "label": "Descripción de la Referencia", "type": "textarea" },
                            { "name": "consentimiento", "label": "Consentimiento Informado", "type": "checkbox", "labelText": "Firmado" },
                            { "name": "tolerancia", "label": "Tolerancia al Estudio", "type": "text", "default": "Buena tolerancia al estudio, sin reacciones adversas al medio contraste." },
                            { "name": "fc", "label": "FC durante el Estudio", "type": "text", "default": "Paciente con FC de 45-55 lpm durante el estudio. Se utilizó una dosis de nitroglicerina sublingual." },
                            { "name": "analisis", "label": "Análisis de Imágenes", "type": "text", "default": "Análisis de imágenes fue por medio de estación de trabajo Vitrea®, todas las mediciones finales incluyendo cortes multiplanares y reconstrucción 3D." },
                            { "name": "calidad", "label": "Calidad de Estudio", "type": "select", "options": ["Buena", "Aceptable", "Limitada"] }
                        ]
                    },
                    {
                        "title": "Anatomía Cardiovascular",
                        "fields": [
                            { "name": "venas_cavas", "label": "Venas Cavas", "type": "text", "default": "Ambas no dilatadas drenando en la aurícula derecha" },
                            { "name": "auricula_derecha", "label": "Aurícula Derecha", "type": "text", "default": "No dilatada" },
                            { "name": "septum_interauricular", "label": "Septum Interauricular", "type": "text", "default": "No se visualizan defectos" },
                            { "name": "seno_coronario", "label": "Seno Coronario", "type": "text", "default": "Drenando a la AD en forma habitual sin dilatación o anomalías" },
                            { "name": "valvula_tricuspide", "label": "Válvula Tricúspide", "type": "text", "default": "No se visualizan defectos por este método" },
                            { "name": "ventriculo_derecho", "label": "Ventrículo Derecho", "type": "text", "default": "No dilatado ni hipertrófico" },
                            { "name": "arteria_pulmonar", "label": "Arteria Pulmonar", "type": "text", "default": "Diámetro Normal" },
                            { "name": "venas_pulmonares", "label": "Venas Pulmonares", "type": "text", "default": "Cuatro drenando a la aurícula izquierda, dos derechas y dos izquierdas" },
                            { "name": "auricula_izquierda", "label": "Aurícula Izquierda", "type": "text", "default": "No se observan trombos en la orejuela izquierda, ni masas o lesiones intracardiacas." },
                            { "name": "ventriculo_izquierdo", "label": "Ventrículo Izquierdo", "type": "text", "default": "No dilatado con hipertrofia concéntrica leve. Motilidad global y regional conservada. FEVI normal 70%." },
                            { "name": "hallazgos_extracardiacos", "label": "Hallazgos Extracardiacos", "type": "text", "default": "Hernia hiatal pequeña" }
                        ]
                    },
                    {
                        "title": "Válvula Aórtica",
                        "fields": [
                            { "name": "cuspides", "label": "Cúspides", "type": "text", "default": "3 cúspides de conformación Normal" },
                            { "name": "calcificaciones_valvula", "label": "Calcificaciones", "type": "text" },
                            { "name": "morfologia_anillo", "label": "Morfología del Anillo Aórtico", "type": "select", "options": ["Elíptica", "Circular"] },
                            { "name": "diametro_menor_anillo", "label": "Diámetro Menor del Anillo (mm)", "type": "number" },
                            { "name": "diametro_mayor_anillo", "label": "Diámetro Mayor del Anillo (mm)", "type": "number" }
                        ]
                    },
                    {
                        "title": "Diámetros de la Aorta",
                        "fields": [
                            { "name": "senos_valsalva_diametro", "label": "Senos de Valsalva (mm)", "type": "number" },
                            { "name": "senos_valsalva_indexado", "label": "Senos de Valsalva Indexado (mm/m² SC)", "type": "number" },
                            { "name": "senos_valsalva_observaciones", "label": "Observaciones Senos de Valsalva", "type": "text", "default": "NORMAL" },
                            { "name": "union_sinotubular_diametro", "label": "Unión Sinotubular (mm)", "type": "number" },
                            { "name": "union_sinotubular_indexado", "label": "Unión Sinotubular Indexado (mm/m² SC)", "type": "number" },
                            { "name": "union_sinotubular_observaciones", "label": "Observaciones Unión Sinotubular", "type": "text", "default": "NORMAL" },
                            { "name": "tubular_ascendente_diametro", "label": "Porción Tubular Ascendente (mm)", "type": "number" },
                            { "name": "tubular_ascendente_indexado", "label": "Porción Tubular Ascendente Indexado (mm/m² SC)", "type": "number" },
                            { "name": "tubular_ascendente_observaciones", "label": "Observaciones Porción Tubular Ascendente", "type": "text", "default": "NORMAL (medición a 40 mm del anillo aórtico)" }
                        ]
                    },
                    {
                        "title": "Score de Calcio Coronario",
                        "fields": [
                            { "name": "calcio_total", "label": "Total (Agatston)", "type": "number", "default": 0 },
                            { "name": "calcio_tci", "label": "TCI", "type": "number", "default": 0 },
                            { "name": "calcio_ada", "label": "ADA", "type": "number", "default": 0 },
                            { "name": "calcio_acd", "label": "ACD", "type": "number", "default": 0 },
                            { "name": "calcio_acx", "label": "ACX", "type": "number", "default": 0 }
                        ]
                    },
                    {
                        "title": "Arteriografía Coronaria No Invasiva - Arteria Coronaria Izquierda",
                        "fields": [
                            { "name": "tci_longitud", "label": "Tronco Coronario Izquierdo - Longitud (mm)", "type": "number", "default": 13 },
                            { "name": "tci_nacimiento", "label": "Nacimiento", "type": "text", "default": "0% POR DIÁMETRO 0% POR ÁREA LUMINAL MÍNIMA" },
                            { "name": "tci_ateromatosis", "label": "Ateromatosis", "type": "text" },
                            { "name": "tci_compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                            { "name": "tci_obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "tci_termina_en", "label": "Termina en", "type": "text" },
                            { "name": "tci_artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ],
                        "repeatableGroups": [
                            {
                                "groupName": "ada_segments",
                                "title": "Arteria Descendente Anterior (ADA) - Segmentos",
                                "repeatable": true,
                                "fields": [
                                    { "name": "segmento", "label": "Segmento", "type": "select", "options": ["Proximal", "Medio", "Distal"] },
                                    { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                                    { "name": "ateromatosis", "label": "Ateromatosis", "type": "text" },
                                    { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text", "default": "0%" },
                                    { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                                    { "name": "puente_intramiocardico", "label": "Puente Intramiocárdico", "type": "text" },
                                    { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                                ]
                            },
                            {
                                "groupName": "ada_ramas",
                                "title": "Ramas de la ADA",
                                "repeatable": true,
                                "fields": [
                                    { "name": "rama", "label": "Rama", "type": "select", "options": ["Primera Rama Diagonal", "Segunda Rama Diagonal", "Tercera Rama Diagonal"] },
                                    { "name": "origen", "label": "Origen", "type": "text" },
                                    { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                                    { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                                    { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                                    { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                                    { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                                ]
                            },
                            {
                                "groupName": "ramus_intermedio",
                                "title": "Arteria del Ramus Intermedio",
                                "repeatable": false,
                                "fields": [
                                    { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                                    { "name": "ateromatosis", "label": "Ateromatosis", "type": "text" },
                                    { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text", "default": "0%" },
                                    { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                                    { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                                ]
                            },
                            {
                                "groupName": "acx_segments",
                                "title": "Arteria Circunfleja (ACX) - Segmentos",
                                "repeatable": true,
                                "fields": [
                                    { "name": "segmento", "label": "Segmento", "type": "select", "options": ["Proximal", "Medio", "Distal"] },
                                    { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                                    { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                                    { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                                    { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                                    { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                                ]
                            },
                            {
                                "groupName": "acx_ramas",
                                "title": "Ramas de la ACX",
                                "repeatable": true,
                                "fields": [
                                    { "name": "rama", "label": "Rama", "type": "select", "options": ["Primera Rama Marginal Obtusa", "Segunda Rama Marginal Obtusa"] },
                                    { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                                    { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                                    { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                                    { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                                    { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                                ]
                            }
                        ]
                    },
                    {
                        "title": "Arteriografía Coronaria No Invasiva - Arteria Coronaria Derecha",
                        "fields": [
                            { "name": "acd_dominancia", "label": "Dominancia", "type": "select", "options": ["Dominante", "No Dominante", "Co-Dominante"] },
                            { "name": "acd_ostium", "label": "Ostium y Nacimiento", "type": "text", "default": "Normal. Trayecto normal" }
                        ],
                        "repeatableGroups": [
                            {
                                "groupName": "acd_segments",
                                "title": "Arteria Coronaria Derecha (ACD) - Segmentos",
                                "repeatable": true,
                                "fields": [
                                    { "name": "segmento", "label": "Segmento", "type": "select", "options": ["Proximal", "Medio", "Distal"] },
                                    { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                                    { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                                    { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                                    { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                                ]
                            },
                            {
                                "groupName": "acd_ramas",
                                "title": "Ramas de la Arteria Coronaria Derecha",
                                "repeatable": true,
                                "fields": [
                                    { "name": "rama", "label": "Rama", "type": "select", "options": ["Arteria Conal y Arteria para el Nodo AV", "Rama Marginal Aguda", "Rama Interventricular Posterior", "Rama Posterolateral"] },
                                    { "name": "origen", "label": "Origen", "type": "text" },
                                    { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                                    { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                                    { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                                    { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                                    { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                                ]
                            }
                        ]
                    },
                    {
                        "title": "Conclusiones Angio TC Cardiaco Multidetector",
                        "fields": [
                            { 
                                "name": "conclusiones", 
                                "label": "Conclusiones Generales", 
                                "type": "textarea",
                                "default": "• Implantación normal de las Arterias Coronarias.\n• El Tronco Coronario Izquierdo no presenta ateromatosis.\n• La Arteria Descendente Anterior es un vaso que no presenta ateromatosis.\n• La Arteria del Ramus Intermedio es un vaso que no presenta ateromatosis.\n• La Arteria Circunfleja es un vaso no dominante que no presenta ateromatosis.\n• La Arteria Coronaria Derecha es un vaso dominante que presenta ateromatosis mixta y compromiso luminal moderado a nivel proximal.\n• Puente Miocárdico a nivel del tercio medio/proximal/distal de la ADA.\n• Ventrículo Izquierdo no dilatado con hipertrofia concéntrica leve. Motilidad global y regional conservada. FEVI normal 70%.\n• Ventrículo Derecho no dilatado ni hipertrófico.\n• Aorta Torácica sin dilatación ni ateromatosis.\n• Aorta Torácica con dilatación, en ningún caso en rango aneurismático con ateromatosis moderada.\n• Drenaje Venoso sistémico y pulmonar normal.\n• Concordancia AV y VA, sin otros defectos congénitos evaluables por este método."
                            },
                            { 
                                "name": "cad_rads", 
                                "label": "CAD-RADS", 
                                "type": "select", 
                                "options": ["CAD-RADS:0", "CAD-RADS:1", "CAD-RADS:2", "CAD-RADS:3", "CAD-RADS:4a", "CAD-RADS:4b", "CAD-RADS:5"],
                                "descriptions": {
                                    "CAD-RADS:0": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556.",
                                    "CAD-RADS:1": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556.). Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa.",
                                    "CAD-RADS:2": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa.",
                                    "CAD-RADS:3": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.",
                                    "CAD-RADS:4a": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.",
                                    "CAD-RADS:4b": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.",
                                    "CAD-RADS:5": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional."
                                }
                            },
                            { 
                                "name": "cad_rads_display", 
                                "label": "CAD-RADS Calculado", 
                                "type": "text", 
                                "readonly": true,
                                "description": "Clasificación según documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556)"
                            }
                        ]
                    }
                ]
            }
        }.reportStructure;

        // Renderizar pestañas
        function renderTabs() {
            const tabList = document.querySelector('.tabs ul');
            const tabContents = document.getElementById('tab-contents');
            tabList.innerHTML = '';
            tabContents.innerHTML = '';

            reportStructure.sections.forEach((section, index) => {
                const tabBtnLi = document.createElement('li');
                tabBtnLi.className = `mr-2 ${index === 0 ? 'border-b-2 border-blue-500' : ''}`;
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 text-lg font-medium focus:outline-none';
                btn.textContent = section.title;
                btn.onclick = () => showTab(index);
                tabBtnLi.appendChild(btn);
                tabList.appendChild(tabBtnLi);

                const contentDiv = document.createElement('div');
                contentDiv.id = `tab-${index}`;
                contentDiv.className = `tab-content ${index === 0 ? '' : 'hidden'}`;

                const formSection = document.createElement('form');
                formSection.id = `form-${index}`;
                formSection.className = 'space-y-4';

                section.fields.forEach(field => {
                    const div = document.createElement('div');
                    div.className = 'mb-4';
                    const label = document.createElement('label');
                    label.className = 'block text-gray-700 text-lg';
                    label.textContent = field.label;
                    div.appendChild(label);

                    let input;
                    if (field.type === 'select') {
                        input = document.createElement('select');
                        input.className = 'w-full p-3 border rounded-lg text-lg';
                        field.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            input.appendChild(option);
                        });
                    } else if (field.type === 'checkbox') {
                        input = document.createElement('input');
                        input.type = 'checkbox';
                        input.className = 'w-6 h-6';
                        label.textContent = field.labelText || field.label;
                        div.insertBefore(input, label);
                    } else if (field.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.className = 'w-full p-3 border rounded-lg text-lg h-32';
                    } else {
                        input = document.createElement('input');
                        input.type = field.type;
                        input.className = 'w-full p-3 border rounded-lg text-lg';
                        if (field.readonly) input.readOnly = true;
                    }
                    input.id = field.name;
                    input.name = field.name;
                    if (field.default) input.value = field.default;
                    if (field.suggestComment) input.addEventListener('change', suggestComment);
                    input.addEventListener('input', saveData);
                    div.appendChild(input);
                    formSection.appendChild(div);
                });

                if (section.repeatableGroups) {
                    section.repeatableGroups.forEach(group => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'mb-4 border p-4 rounded-lg';
                        const groupTitle = document.createElement('h3');
                        groupTitle.className = 'text-lg font-medium mb-2';
                        groupTitle.textContent = group.title;
                        groupDiv.appendChild(groupTitle);

                        const instancesDiv = document.createElement('div');
                        instancesDiv.id = `${group.groupName}-instances`;
                        groupDiv.appendChild(instancesDiv);

                        if (group.repeatable) {
                            const addBtn = document.createElement('button');
                            addBtn.type = 'button';
                            addBtn.className = 'bg-indigo-500 text-white px-4 py-2 rounded-lg text-lg hover:bg-indigo-600';
                            addBtn.textContent = `Añadir Instancia`;
                            addBtn.onclick = () => addRepeatableInstance(group, instancesDiv);
                            groupDiv.appendChild(addBtn);
                        } else {
                            addRepeatableInstance(group, instancesDiv, false);
                        }
                        formSection.appendChild(groupDiv);
                    });
                }
                contentDiv.appendChild(formSection);
                tabContents.appendChild(contentDiv);
            });

            // Añadir pestaña de Vista Previa
            const previewTabLi = document.createElement('li');
            previewTabLi.className = 'mr-2';
            const previewBtn = document.createElement('button');
            previewBtn.className = 'px-4 py-2 text-lg font-medium focus:outline-none';
            previewBtn.textContent = 'Vista Previa';
            previewBtn.onclick = () => showTab(reportStructure.sections.length);
            previewTabLi.appendChild(previewBtn);
            tabList.appendChild(previewTabLi);

            const previewContent = document.createElement('div');
            previewContent.id = `tab-${reportStructure.sections.length}`;
            previewContent.className = 'tab-content hidden';
            const preview = document.getElementById('preview');
            preview.classList.remove('hidden');
            previewContent.appendChild(preview);
            tabContents.appendChild(previewContent);

            loadData();
            updatePreview();
            calculateCADRADS();
        }

        // Mostrar pestaña
        function showTab(index) {
            document.querySelectorAll('.tabs li').forEach((li, i) => {
                li.classList.toggle('border-b-2 border-blue-500', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('hidden', i !== index);
            });
            if (index === reportStructure.sections.length) {
                updatePreview();
            }
        }

        // Añadir instancia repetible
        let instanceCounter = {};
        function addRepeatableInstance(group, container, addRemove = true) {
            const groupName = group.groupName;
            if (!instanceCounter[groupName]) instanceCounter[groupName] = 0;
            instanceCounter[groupName]++;
            const instanceId = `${groupName}-${instanceCounter[groupName]}`;

            const instanceDiv = document.createElement('div');
            instanceDiv.className = 'mb-4 border-t pt-2';
            instanceDiv.id = instanceId;

            group.fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'mb-2';
                const label = document.createElement('label');
                label.className = 'block text-gray-700 text-lg';
                label.textContent = field.label;
                div.appendChild(label);

                let input;
                if (field.type === 'select') {
                    input = document.createElement('select');
                    input.className = 'w-full p-3 border rounded-lg text-lg';
                    field.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        input.appendChild(option);
                    });
                } else if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = 'w-full p-3 border rounded-lg text-lg h-24';
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'w-full p-3 border rounded-lg text-lg';
                }
                input.name = `${instanceId}-${field.name}`;
                if (field.default) input.value = field.default;
                if (field.suggestComment) input.addEventListener('change', suggestComment);
                input.addEventListener('input', saveData);
                div.appendChild(input);
                instanceDiv.appendChild(div);
            });

            if (addRemove) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'bg-red-500 text-white px-4 py-2 rounded-lg text-lg hover:bg-red-600 mt-2';
                removeBtn.textContent = 'Eliminar';
                removeBtn.onclick = () => {
                    instanceDiv.remove();
                    saveData();
                };
                instanceDiv.appendChild(removeBtn);
            }

            container.appendChild(instanceDiv);
        }

        // Sugerir comentario basado en % obstrucción
        function suggestComment(event) {
            const input = event.target;
            const value = parseInt(input.value) || 0;
            let suggestion = '';
            if (value === 0) suggestion = 'No presenta ateromatosis';
            else if (value < 25) suggestion = 'Ateromatosis mínima';
            else if (value < 50) suggestion = 'Ateromatosis leve';
            else if (value < 70) suggestion = 'Ateromatosis moderada';
            else if (value < 100) suggestion = 'Ateromatosis severa';
            else suggestion = 'Oclusión total';

            const parent = input.closest('div.mb-4');
            const aterField = parent.querySelector('input[name*="ateromatosis"]');
            if (aterField) aterField.value = suggestion;
            const compField = parent.querySelector('input[name*="compromiso_luminal"]');
            if (compField) compField.value = `${value}%`;

            calculateCADRADS();
            saveData();
        }

        // Cálculo automático de CAD-RADS
        function calculateCADRADS() {
            // Recopilar máximos por vaso
            let lm_obstr = parseInt(document.querySelector('input[name="tci_obstruccion"]')?.value || 0);

            let lad_obstr = 0;
            document.querySelectorAll('[id^="ada_segments-instances"] input[name*="obstruccion"], [id^="ada_ramas-instances"] input[name*="obstruccion"], [id^="ramus_intermedio-instances"] input[name*="obstruccion"]').forEach(input => {
                lad_obstr = Math.max(lad_obstr, parseInt(input.value) || 0);
            });

            let lcx_obstr = 0;
            document.querySelectorAll('[id^="acx_segments-instances"] input[name*="obstruccion"], [id^="acx_ramas-instances"] input[name*="obstruccion"]').forEach(input => {
                lcx_obstr = Math.max(lcx_obstr, parseInt(input.value) || 0);
            });

            let rca_obstr = 0;
            document.querySelectorAll('[id^="acd_segments-instances"] input[name*="obstruccion"], [id^="acd_ramas-instances"] input[name*="obstruccion"]').forEach(input => {
                rca_obstr = Math.max(rca_obstr, parseInt(input.value) || 0);
            });

            const max_sten = Math.max(lm_obstr, lad_obstr, lcx_obstr, rca_obstr);

            let category = '0';
            if (max_sten === 0) category = '0';
            else if (max_sten < 25) category = '1';
            else if (max_sten < 50) category = '2';
            else if (max_sten < 70) category = '3';
            else if (max_sten < 100) category = '4';
            else category = '5';

            if (category === '4') {
                let high_vessels = 0;
                if (lad_obstr >= 70) high_vessels++;
                if (lcx_obstr >= 70) high_vessels++;
                if (rca_obstr >= 70) high_vessels++;
                if (lm_obstr >= 50 || high_vessels >= 3) category = '4b';
                else category = '4a';
            }

            const cadSelect = document.getElementById('cad_rads');
            if (cadSelect) cadSelect.value = `CAD-RADS:${category}`;

            const display = document.getElementById('cad_rads_display');
            if (display) display.value = `CAD-RADS ${category}`;

            // Actualizar conclusiones con descripción
            const conclusionsTextarea = document.getElementById('conclusiones');
            if (conclusionsTextarea && cadSelect) {
                const selected = cadSelect.value;
                const desc = cadSelect.options[cadSelect.selectedIndex].dataset.desc || reportStructure.sections.find(s => s.title === 'Conclusiones Angio TC Cardiaco Multidetector').fields.find(f => f.name === 'cad_rads').descriptions[selected];
                conclusionsTextarea.value = conclusionsTextarea.defaultValue + `\n• ${selected} ${desc}`;
            }

            updatePreview();
        }

        // Guardar datos
        function saveData() {
            const data = {};
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.name) {
                    data[el.name] = el.type === 'checkbox' ? (el.checked ? 'on' : '') : el.value;
                }
            });
            localStorage.setItem('reportData', JSON.stringify(data));
            calculateCADRADS();
            updatePreview();
        }

        // Cargar datos
        function loadData() {
            const savedData = JSON.parse(localStorage.getItem('reportData'));
            if (savedData) {
                document.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.name && savedData[el.name] !== undefined) {
                        if (el.type === 'checkbox') el.checked = savedData[el.name] === 'on';
                        else el.value = savedData[el.name];
                    }
                });
            }
            calculateCADRADS();
            updatePreview();
        }

        // Actualizar vista previa
        function updatePreview() {
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            let html = '<div class="prose max-w-none">';

            reportStructure.sections.forEach(section => {
                html += `<h2>${section.title}</h2>`;
                section.fields.forEach(field => {
                    const el = document.getElementById(field.name);
                    const value = el ? (el.type === 'checkbox' ? (el.checked ? 'Sí' : 'No') : el.value) : field.default || '';
                    html += `<p><strong>${field.label}:</strong> ${value}</p>`;
                });
                if (section.repeatableGroups) {
                    section.repeatableGroups.forEach(group => {
                        html += `<h3>${group.title}</h3>`;
                        const instances = document.querySelectorAll(`#${group.groupName}-instances > div`);
                        instances.forEach(instance => {
                            html += '<div class="border p-2 mb-2">';
                            group.fields.forEach(field => {
                                const input = instance.querySelector(`[name*="${field.name}"]`);
                                if (input) html += `<p><strong>${field.label}:</strong> ${input.value}</p>`;
                            });
                            html += '</div>';
                        });
                    });
                }
            });

            html += '</div>';
            preview.innerHTML = html;
        }

        // Precargas
        document.getElementById('preload-normal').addEventListener('click', () => {
            document.querySelectorAll('input[type="number"][name*="obstruccion"]').forEach(input => input.value = 0);
            document.querySelectorAll('input[name*="ateromatosis"], input[name*="compromiso_luminal"]').forEach(input => input.value = '0% / No presenta');
            saveData();
        });

        document.getElementById('preload-severe').addEventListener('click', () => {
            document.querySelectorAll('input[type="number"][name*="obstruccion"]').forEach(input => input.value = 80);
            document.querySelectorAll('input[name*="ateromatosis"]').forEach(input => input.value = 'Severa');
            saveData();
        });

        // Generar PDF
        document.getElementById('generate-pdf').addEventListener('click', () => {
            const element = document.getElementById('preview');
            html2pdf().from(element).save('reporte_angiotc.pdf');
        });

        // Inicializar
        renderTabs();

        // Añadir data-desc a options de CAD-RADS
        const cadSelect = document.getElementById('cad_rads');
        if (cadSelect) {
            Array.from(cadSelect.options).forEach(opt => {
                opt.dataset.desc = reportStructure.sections.find(s => s.title === 'Conclusiones Angio TC Cardiaco Multidetector').fields.find(f => f.name === 'cad_rads').descriptions[opt.value];
            });
            cadSelect.addEventListener('change', () => {
                const selected = cadSelect.value;
                const desc = cadSelect.options[cadSelect.selectedIndex].dataset.desc;
                const display = document.getElementById('cad_rads_display');
                if (display) display.value = `${selected} ${desc}`;
                saveData();
            });
        }
    </script>
</body>
</html>
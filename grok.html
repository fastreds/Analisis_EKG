<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reporte Angio-TAC Cardiaco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; }
        .form-section { background-color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .preview-section { background-color: white; border-radius: 8px; padding: 20px; height: 100%; font-size: 14px; line-height: 1.6; }
        .cad-rads-display { font-weight: bold; padding: 16px; border-radius: 8px; text-align: center; margin-top: 16px; transition: background-color 0.3s ease; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Generador de Reporte Angio-TAC Cardiaco</h1>
            <p class="text-gray-600">Complete el formulario para generar el informe y calcular el CAD-RADS automáticamente.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <div class="flex space-x-2 mb-4">
                    <button id="preload-normal-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">Cargar Escenario Normal</button>
                    <button id="preload-severe-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors">Cargar Escenario Severo</button>
                </div>
                <div id="form-container"></div>
            </div>

            <div class="sticky top-8 self-start">
                <div class="form-section">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Vista Previa del Informe</h2>
                    <div id="preview-container" class="preview-section prose max-w-none">
                        <p class="text-gray-500">La vista previa del informe aparecerá aquí...</p>
                    </div>
                    
                    <div id="cad-rads-result">
                        <h3 class="text-lg font-bold mt-4">CAD-RADS Calculado</h3>
                        <div id="cad-rads-display" class="cad-rads-display bg-gray-200 text-gray-800">
                            Aún no calculado
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button id="save-btn" class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">Guardar Progreso</button>
                        <button id="clear-btn" class="bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors">Limpiar Formulario</button>
                    </div>
                    <button id="generate-pdf-btn" class="w-full mt-4 bg-purple-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-purple-700 transition-colors text-lg">Generar PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- 1. ESTRUCTURA DEL REPORTE EN FORMATO JSON ---
    const reportStructure = {
        "sections": [
            {
                "title": "Datos del Paciente",
                "fields": [
                    { "name": "nombre", "label": "Nombre", "type": "text" },
                    { "name": "identificacion", "label": "Identificación", "type": "text" },
                    { "name": "genero", "label": "Género", "type": "select", "options": ["MASCULINO", "FEMENINA"] },
                    { "name": "edad", "label": "Edad (Años)", "type": "number" },
                    { "name": "peso", "label": "Peso (Kg)", "type": "number" },
                    { "name": "talla", "label": "Talla (CM)", "type": "number" },
                    { "name": "area_sc", "label": "Área SC (m²)", "type": "number" },
                    { "name": "fecha_estudio", "label": "Fecha del Estudio", "type": "date" },
                    { "name": "medico_refiere", "label": "Médico que Refiere", "type": "text" }
                ]
            },
            {
                "title": "Métodos del Estudio",
                "fields": [
                    { "name": "tomografo", "label": "Tomógrafo", "type": "text", "default": "Canon Aquilion® / 160 cortes" },
                    { "name": "tiempo_rotacion", "label": "Tiempo de Rotación", "type": "text", "default": "0.5/seg" },
                    { "name": "ecg_gating", "label": "ECG-gating", "type": "text", "default": "Retrospectivo (variabilidad FC respiratoria marcada)" },
                    { "name": "medio_contraste", "label": "Medio Contraste", "type": "text", "default": "Ultravist 370" },
                    { "name": "volumen_contraste", "label": "Volumen de Medio Contraste (ml)", "type": "number", "default": 85 },
                    { "name": "velocidad_infusion", "label": "Velocidad de Infusión (ml/s)", "type": "number", "default": 5 },
                    { "name": "ritmo_estudio", "label": "Ritmo durante el Estudio", "type": "text", "default": "Ritmo bradicardia sinusal" }
                ]
            },
            {
                "title": "Motivo de Estudio y Generalidades",
                "fields": [
                    { "name": "motivo", "label": "Descripción de la Referencia", "type": "textarea" },
                    { "name": "consentimiento", "label": "Consentimiento Informado", "type": "checkbox", "labelText": "Firmado" },
                    { "name": "tolerancia", "label": "Tolerancia al Estudio", "type": "text", "default": "Buena tolerancia al estudio, sin reacciones adversas al medio contraste." },
                    { "name": "fc", "label": "FC durante el Estudio", "type": "text", "default": "Paciente con FC de 45-55 lpm durante el estudio. Se utilizó una dosis de nitroglicerina sublingual." },
                    { "name": "analisis", "label": "Análisis de Imágenes", "type": "text", "default": "Análisis de imágenes fue por medio de estación de trabajo Vitrea®, todas las mediciones finales incluyendo cortes multiplanares y reconstrucción 3D." },
                    { "name": "calidad", "label": "Calidad de Estudio", "type": "select", "options": ["Buena", "Aceptable", "Limitada"] }
                ]
            },
            {
                "title": "Anatomía Cardiovascular",
                "fields": [
                    { "name": "venas_cavas", "label": "Venas Cavas", "type": "text", "default": "Ambas no dilatadas drenando en la aurícula derecha" },
                    { "name": "auricula_derecha", "label": "Aurícula Derecha", "type": "text", "default": "No dilatada" },
                    { "name": "septum_interauricular", "label": "Septum Interauricular", "type": "text", "default": "No se visualizan defectos" },
                    { "name": "seno_coronario", "label": "Seno Coronario", "type": "text", "default": "Drenando a la AD en forma habitual sin dilatación o anomalías" },
                    { "name": "valvula_tricuspide", "label": "Válvula Tricúspide", "type": "text", "default": "No se visualizan defectos por este método" },
                    { "name": "ventriculo_derecho", "label": "Ventrículo Derecho", "type": "text", "default": "No dilatado ni hipertrófico" },
                    { "name": "arteria_pulmonar", "label": "Arteria Pulmonar", "type": "text", "default": "Diámetro Normal" },
                    { "name": "venas_pulmonares", "label": "Venas Pulmonares", "type": "text", "default": "Cuatro drenando a la aurícula izquierda, dos derechas y dos izquierdas" },
                    { "name": "auricula_izquierda", "label": "Aurícula Izquierda", "type": "text", "default": "No se observan trombos en la orejuela izquierda, ni masas o lesiones intracardiacas." },
                    { "name": "ventriculo_izquierdo", "label": "Ventrículo Izquierdo", "type": "text", "default": "No dilatado con hipertrofia concéntrica leve. Motilidad global y regional conservada. FEVI normal 70%." },
                    { "name": "hallazgos_extracardiacos", "label": "Hallazgos Extracardiacos", "type": "text", "default": "Hernia hiatal pequeña" }
                ]
            },
            {
                "title": "Válvula Aórtica",
                "fields": [
                    { "name": "cuspides", "label": "Cúspides", "type": "text", "default": "3 cúspides de conformación Normal" },
                    { "name": "calcificaciones_valvula", "label": "Calcificaciones", "type": "text" },
                    { "name": "morfologia_anillo", "label": "Morfología del Anillo Aórtico", "type": "select", "options": ["Elíptica", "Circular"] },
                    { "name": "diametro_menor_anillo", "label": "Diámetro Menor del Anillo (mm)", "type": "number" },
                    { "name": "diametro_mayor_anillo", "label": "Diámetro Mayor del Anillo (mm)", "type": "number" }
                ]
            },
            {
                "title": "Diámetros de la Aorta",
                "fields": [
                    { "name": "senos_valsalva_diametro", "label": "Senos de Valsalva (mm)", "type": "number" },
                    { "name": "senos_valsalva_indexado", "label": "Senos de Valsalva Indexado (mm/m² SC)", "type": "number" },
                    { "name": "senos_valsalva_observaciones", "label": "Observaciones Senos de Valsalva", "type": "text", "default": "NORMAL" },
                    { "name": "union_sinotubular_diametro", "label": "Unión Sinotubular (mm)", "type": "number" },
                    { "name": "union_sinotubular_indexado", "label": "Unión Sinotubular Indexado (mm/m² SC)", "type": "number" },
                    { "name": "union_sinotubular_observaciones", "label": "Observaciones Unión Sinotubular", "type": "text", "default": "NORMAL" },
                    { "name": "tubular_ascendente_diametro", "label": "Porción Tubular Ascendente (mm)", "type": "number" },
                    { "name": "tubular_ascendente_indexado", "label": "Porción Tubular Ascendente Indexado (mm/m² SC)", "type": "number" },
                    { "name": "tubular_ascendente_observaciones", "label": "Observaciones Porción Tubular Ascendente", "type": "text", "default": "NORMAL (medición a 40 mm del anillo aórtico)" }
                ]
            },
            {
                "title": "Score de Calcio Coronario",
                "fields": [
                    { "name": "calcio_total", "label": "Total (Agatston)", "type": "number", "default": 0 },
                    { "name": "calcio_tci", "label": "TCI", "type": "number", "default": 0 },
                    { "name": "calcio_ada", "label": "ADA", "type": "number", "default": 0 },
                    { "name": "calcio_acd", "label": "ACD", "type": "number", "default": 0 },
                    { "name": "calcio_acx", "label": "ACX", "type": "number", "default": 0 }
                ]
            },
            {
                "title": "Arteriografía Coronaria No Invasiva - Arteria Coronaria Izquierda",
                "fields": [
                    { "name": "tci_longitud", "label": "Tronco Coronario Izquierdo - Longitud (mm)", "type": "number", "default": 13 },
                    { "name": "tci_nacimiento", "label": "Nacimiento", "type": "text", "default": "0% POR DIÁMETRO 0% POR ÁREA LUMINAL MÍNIMA" },
                    { "name": "tci_ateromatosis", "label": "Ateromatosis", "type": "text" },
                    { "name": "tci_compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                    { "name": "tci_obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                    { "name": "tci_termina_en", "label": "Termina en", "type": "text" },
                    { "name": "tci_artefacto", "label": "Presencia de Artefacto", "type": "text" }
                ],
                "repeatableGroups": [
                    {
                        "groupName": "ada_segments",
                        "title": "Arteria Descendente Anterior (ADA) - Segmentos",
                        "repeatable": true,
                        "fields": [
                            { "name": "segmento", "label": "Segmento", "type": "select", "options": ["Proximal", "Medio", "Distal"] },
                            { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                            { "name": "ateromatosis", "label": "Ateromatosis", "type": "text" },
                            { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text", "default": "0%" },
                            { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "puente_intramiocardico", "label": "Puente Intramiocárdico", "type": "text" },
                            { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ]
                    },
                    {
                        "groupName": "ada_ramas",
                        "title": "Ramas de la ADA",
                        "repeatable": true,
                        "fields": [
                            { "name": "rama", "label": "Rama", "type": "select", "options": ["Primera Rama Diagonal", "Segunda Rama Diagonal", "Tercera Rama Diagonal"] },
                            { "name": "origen", "label": "Origen", "type": "text" },
                            { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                            { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                            { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                            { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ]
                    },
                    {
                        "groupName": "ramus_intermedio",
                        "title": "Arteria del Ramus Intermedio",
                        "repeatable": false,
                        "fields": [
                            { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                            { "name": "ateromatosis", "label": "Ateromatosis", "type": "text" },
                            { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text", "default": "0%" },
                            { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ]
                    },
                    {
                        "groupName": "acx_segments",
                        "title": "Arteria Circunfleja (ACX) - Segmentos",
                        "repeatable": true,
                        "fields": [
                            { "name": "segmento", "label": "Segmento", "type": "select", "options": ["Proximal", "Medio", "Distal"] },
                            { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                            { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                            { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                            { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ]
                    },
                    {
                        "groupName": "acx_ramas",
                        "title": "Ramas de la ACX",
                        "repeatable": true,
                        "fields": [
                            { "name": "rama", "label": "Rama", "type": "select", "options": ["Primera Rama Marginal Obtusa", "Segunda Rama Marginal Obtusa"] },
                            { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                            { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                            { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                            { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ]
                    }
                ]
            },
            {
                "title": "Arteriografía Coronaria No Invasiva - Arteria Coronaria Derecha",
                "fields": [
                    { "name": "acd_dominancia", "label": "Dominancia", "type": "select", "options": ["Dominante", "No Dominante", "Co-Dominante"] },
                    { "name": "acd_ostium", "label": "Ostium y Nacimiento", "type": "text", "default": "Normal. Trayecto normal" }
                ],
                "repeatableGroups": [
                    {
                        "groupName": "acd_segments",
                        "title": "Arteria Coronaria Derecha (ACD) - Segmentos",
                        "repeatable": true,
                        "fields": [
                            { "name": "segmento", "label": "Segmento", "type": "select", "options": ["Proximal", "Medio", "Distal"] },
                            { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                            { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                            { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ]
                    },
                    {
                        "groupName": "acd_ramas",
                        "title": "Ramas de la Arteria Coronaria Derecha",
                        "repeatable": true,
                        "fields": [
                            { "name": "rama", "label": "Rama", "type": "select", "options": ["Arteria Conal y Arteria para el Nodo AV", "Rama Marginal Aguda", "Rama Interventricular Posterior", "Rama Posterolateral"] },
                            { "name": "origen", "label": "Origen", "type": "text" },
                            { "name": "calibre_desarrollo", "label": "Calibre y Desarrollo", "type": "text" },
                            { "name": "ateromatosis", "label": "Ateromatosis", "type": "text", "default": "0%" },
                            { "name": "compromiso_luminal", "label": "Compromiso Luminal", "type": "text" },
                            { "name": "obstruccion", "label": "% de Obstrucción", "type": "number", "default": 0, "suggestComment": true },
                            { "name": "artefacto", "label": "Presencia de Artefacto", "type": "text" }
                        ]
                    }
                ]
            },
            {
                "title": "Conclusiones Angio TC Cardiaco Multidetector",
                "fields": [
                    { 
                        "name": "conclusiones", 
                        "label": "Conclusiones Generales", 
                        "type": "textarea",
                        "default": "• Implantación normal de las Arterias Coronarias.\n• El Tronco Coronario Izquierdo no presenta ateromatosis.\n• La Arteria Descendente Anterior es un vaso que no presenta ateromatosis.\n• La Arteria del Ramus Intermedio es un vaso que no presenta ateromatosis.\n• La Arteria Circunfleja es un vaso no dominante que no presenta ateromatosis.\n• La Arteria Coronaria Derecha es un vaso dominante que presenta ateromatosis mixta y compromiso luminal moderado a nivel proximal.\n• Puente Miocárdico a nivel del tercio medio/proximal/distal de la ADA.\n• Ventrículo Izquierdo no dilatado con hipertrofia concéntrica leve. Motilidad global y regional conservada. FEVI normal 70%.\n• Ventrículo Derecho no dilatado ni hipertrófico.\n• Aorta Torácica sin dilatación ni ateromatosis.\n• Aorta Torácica con dilatación, en ningún caso en rango aneurismático con ateromatosis moderada.\n• Drenaje Venoso sistémico y pulmonar normal.\n• Concordancia AV y VA, sin otros defectos congénitos evaluables por este método."
                    },
                    { 
                        "name": "cad_rads", 
                        "label": "CAD-RADS", 
                        "type": "select", 
                        "options": ["CAD-RADS:0", "CAD-RADS:1", "CAD-RADS:2", "CAD-RADS:3", "CAD-RADS:4a", "CAD-RADS:4b", "CAD-RADS:5"],
                        "descriptions": {
                            "CAD-RADS:0": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556.",
                            "CAD-RADS:1": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556.). Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa.",
                            "CAD-RADS:2": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa.",
                            "CAD-RADS:3": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.",
                            "CAD-RADS:4a": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.",
                            "CAD-RADS:4b": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.",
                            "CAD-RADS:5": "según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional."
                        }
                    },
                    { 
                        "name": "cad_rads_display", 
                        "label": "CAD-RADS Calculado", 
                        "type": "text", 
                        "readonly": true,
                        "description": "Clasificación según documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556)"
                    }
                ]
            }
        ]
    };

    // --- 2. LÓGICA DE LA APLICACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        const formContainer = document.getElementById('form-container');
        const previewContainer = document.getElementById('preview-container');
        const cadRadsDisplay = document.getElementById('cad-rads-display');

        // --- RENDERIZADO DEL FORMULARIO ---
        function renderForm() {
            reportStructure.sections.forEach(section => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'form-section';
                
                const titleEl = document.createElement('h2');
                titleEl.className = 'text-xl font-bold mb-4 border-b pb-2';
                titleEl.textContent = section.title;
                sectionEl.appendChild(titleEl);

                if (section.fields) {
                    section.fields.forEach(field => {
                        sectionEl.appendChild(createField(field));
                    });
                } else if (section.repeatableGroups) {
                    section.repeatableGroups.forEach(group => {
                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'mb-6';
                        const groupTitle = document.createElement('h3');
                        groupTitle.className = 'text-lg font-bold mb-2';
                        groupTitle.textContent = group.title;
                        groupContainer.appendChild(groupTitle);

                        if (group.repeatable) {
                            const addBtn = document.createElement('button');
                            addBtn.type = 'button';
                            addBtn.className = 'bg-blue-500 text-white py-2 px-4 rounded mb-2';
                            addBtn.textContent = 'Añadir ' + group.title.replace(' - ', ' ');
                            addBtn.onclick = () => addRepeatableInstance(group, groupContainer);
                            groupContainer.appendChild(addBtn);
                        } else {
                            addRepeatableInstance(group, groupContainer, false);
                        }
                        sectionEl.appendChild(groupContainer);
                    });
                }
                formContainer.appendChild(sectionEl);
            });
        }

        let repeatableCounter = {};

        function addRepeatableInstance(group, container, addRemove = true) {
            const groupName = group.groupName;
            if (!repeatableCounter[groupName]) repeatableCounter[groupName] = 0;
            repeatableCounter[groupName]++;
            const instanceId = `${groupName}-${repeatableCounter[groupName]}`;

            const instanceDiv = document.createElement('div');
            instanceDiv.className = 'mb-4 p-4 border rounded';
            instanceDiv.id = instanceId;

            group.fields.forEach(field => {
                const fieldData = { ...field, id: `${instanceId}-${field.name}` };
                instanceDiv.appendChild(createField(fieldData));
            });

            if (addRemove) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'bg-red-500 text-white py-2 px-4 rounded mt-2';
                removeBtn.textContent = 'Eliminar';
                removeBtn.onclick = () => instanceDiv.remove();
                instanceDiv.appendChild(removeBtn);
            }

            container.appendChild(instanceDiv);
        }

        function createField(field) {
            const container = document.createElement('div');
            container.className = 'mb-4';

            const label = document.createElement('label');
            label.className = 'block text-gray-700 font-bold mb-2';
            label.setAttribute('for', field.id || field.name);
            label.textContent = field.label;
            container.appendChild(label);

            let input;
            switch (field.type) {
                case 'select':
                    input = document.createElement('select');
                    field.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        input.appendChild(option);
                    });
                    break;
                case 'checkbox':
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'w-5 h-5';
                    label.textContent = field.labelText || field.label;
                    container.insertBefore(input, label);
                    break;
                case 'textarea':
                    input = document.createElement('textarea');
                    input.rows = field.rows || 5;
                    break;
                default:
                    input = document.createElement('input');
                    input.type = field.type;
                    if (field.placeholder) input.placeholder = field.placeholder;
                    if (field.min) input.min = field.min;
                    if (field.max) input.max = field.max;
                    if (field.readonly) input.readOnly = true;
                    break;
            }

            input.id = field.id || field.name;
            input.name = field.name;
            input.className = 'w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
            if (field.default) input.value = field.default;
            if (field.readonly) input.classList.add('bg-gray-100');
            if (field.suggestComment) input.addEventListener('input', (e) => suggestComment(e, field));
            container.appendChild(input);
            return container;
        }

        function suggestComment(e, field) {
            const value = parseInt(e.target.value) || 0;
            let suggestion = '';
            if (value === 0) suggestion = 'No presenta ateromatosis';
            else if (value < 25) suggestion = 'mínima';
            else if (value < 50) suggestion = 'leve';
            else if (value < 70) suggestion = 'moderada';
            else if (value < 100) suggestion = 'severa';
            else suggestion = 'oclusión total';

            const parent = e.target.closest('div.mb-4');
            const aterField = parent.querySelector('select[name*="ateromatosis"]') || parent.querySelector('input[name*="ateromatosis"]');
            if (aterField) aterField.value = `Leve ${suggestion}`; // Ajusta según opciones
            const compField = parent.querySelector('select[name*="compromiso_luminal"]') || parent.querySelector('input[name*="compromiso_luminal"]');
            if (compField) compField.value = value < 25 ? 'Ninguno' : value < 50 ? 'Leve' : value < 70 ? 'Moderado' : 'Severo';

            updateAll();
        }

        // --- LÓGICA DE ACTUALIZACIÓN ---
        function getFormData() {
            const data = {};
            reportStructure.sections.forEach(section => {
                data[section.title] = {};
                if (section.fields) {
                    section.fields.forEach(field => {
                        const el = document.getElementById(field.name);
                        data[section.title][field.name] = el.type === 'checkbox' ? el.checked : el.value;
                    });
                }
                if (section.repeatableGroups) {
                    section.repeatableGroups.forEach(group => {
                        data[section.title][group.groupName] = [];
                        const instances = document.querySelectorAll(`#${group.groupName}-instances > div`);
                        instances.forEach(instance => {
                            const instanceData = {};
                            group.fields.forEach(field => {
                                const input = instance.querySelector(`[name*="${field.name}"]`);
                                if (input) instanceData[field.name] = input.value;
                            });
                            data[section.title][group.groupName].push(instanceData);
                        });
                    });
                }
            });
            return data;
        }

        function updateAll() {
            const data = getFormData();
            updatePreview(data);
            calculateCadRads(data);
        }

        function updatePreview(data) {
            let html = '';
            reportStructure.sections.forEach(section => {
                html += `<h3>${section.title}</h3>`;
                if (section.fields) {
                    section.fields.forEach(field => {
                        html += `<p><strong>${field.label}:</strong> ${data[section.title][field.name] || (field.default || '')}</p>`;
                    });
                }
                if (section.repeatableGroups) {
                    section.repeatableGroups.forEach(group => {
                        html += `<h4>${group.title}</h4>`;
                        data[section.title][group.groupName].forEach(instance => {
                            html += '<div style="margin-bottom: 1em;">';
                            group.fields.forEach(field => {
                                html += `<p><strong>${field.label}:</strong> ${instance[field.name] || (field.default || '')}</p>`;
                            });
                            html += '</div>';
                        });
                    });
                }
            });
            previewContainer.innerHTML = html;
        }

        function calculateCadRads(data) {
            let maxStenosis = 0;
            let isTCI_Affected = false;
            let affectedVessels = 0;

            // Calcular para Izquierda
            const izquierda = data['Arteriografía Coronaria No Invasiva - Arteria Coronaria Izquierda'];
            const tci_obstr = parseInt(izquierda.tci_obstruccion) || 0;
            if (tci_obstr >= 50) isTCI_Affected = true;
            maxStenosis = Math.max(maxStenosis, tci_obstr);

            ['ada_segments', 'ada_ramas', 'ramus_intermedio', 'acx_segments', 'acx_ramas'].forEach(groupName => {
                if (izquierda[groupName]) {
                    izquierda[groupName].forEach(instance => {
                        const obstr = parseInt(instance.obstruccion) || 0;
                        maxStenosis = Math.max(maxStenosis, obstr);
                        if (obstr >= 70) affectedVessels++;
                    });
                }
            });

            // Calcular para Derecha
            const derecha = data['Arteriografía Coronaria No Invasiva - Arteria Coronaria Derecha'];
            ['acd_segments', 'acd_ramas'].forEach(groupName => {
                if (derecha[groupName]) {
                    derecha[groupName].forEach(instance => {
                        const obstr = parseInt(instance.obstruccion) || 0;
                        maxStenosis = Math.max(maxStenosis, obstr);
                        if (obstr >= 70) affectedVessels++;
                    });
                }
            });

            let cadRads = 'CAD-RADS 0';
            let color = 'bg-gray-200';

            if (maxStenosis === 0) { cadRads = 'CAD-RADS 0'; color = 'bg-gray-400'; }
            else if (maxStenosis < 25) { cadRads = 'CAD-RADS 1'; color = 'bg-green-500'; }
            else if (maxStenosis < 50) { cadRads = 'CAD-RADS 2'; color = 'bg-yellow-400'; }
            else if (maxStenosis < 70) { cadRads = 'CAD-RADS 3'; color = 'bg-orange-500'; }
            else if (maxStenosis < 100) {
                cadRads = 'CAD-RADS 4A'; 
                if (affectedVessels >= 3 || isTCI_Affected) cadRads = 'CAD-RADS 4B';
                color = 'bg-red-500';
            }
            else { cadRads = 'CAD-RADS 5'; color = 'bg-red-700'; }

            cadRadsDisplay.textContent = cadRads;
            cadRadsDisplay.className = `cad-rads-display ${color} text-white`;

            // Actualizar conclusiones con CAD-RADS
            const conclusionsField = document.getElementById('conclusiones');
            if (conclusionsField) {
                const desc = reportStructure.sections.find(s => s.title === 'Conclusiones Angio TC Cardiaco Multidetector').fields.find(f => f.name === 'cad_rads').descriptions[cadRads];
                conclusionsField.value = conclusionsField.defaultValue + `\n${cadRads} ${desc}`;
            }
        }

        // --- MANEJO DE EVENTOS ---
        formContainer.addEventListener('input', updateAll);

        document.getElementById('preload-normal-btn').addEventListener('click', () => {
            loadScenario('normal');
        });
        document.getElementById('preload-severe-btn').addEventListener('click', () => {
            loadScenario('severe');
        });
        document.getElementById('save-btn').addEventListener('click', () => {
            localStorage.setItem('angioTacReportData', JSON.stringify(getFormData()));
            alert('Progreso guardado en el navegador.');
        });
        document.getElementById('clear-btn').addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres limpiar el formulario?')) {
                location.reload();
            }
        });
        document.getElementById('generate-pdf-btn').addEventListener('click', () => {
            const element = document.getElementById('preview-container');
            const opt = {
                margin:       1,
                filename:     'Reporte_AngioTAC.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        });

        function loadScenario(type) {
            document.querySelectorAll('input[type="number"][name*="obstruccion"]').forEach(input => input.value = type === 'normal' ? 0 : 80);
            document.querySelectorAll('input[name*="ateromatosis"], input[name*="compromiso_luminal"]').forEach(input => input.value = type === 'normal' ? '0% / No presenta' : 'Severa');
            updateAll();
        }

        // --- INICIALIZACIÓN ---
        renderForm();
        const savedData = localStorage.getItem('angioTacReportData');
        if (savedData) {
            loadData(JSON.parse(savedData));
        } else {
            updateAll(); // Initial call
        }

        function loadData(data) {
            reportStructure.sections.forEach(section => {
                if (section.fields) {
                    section.fields.forEach(field => {
                        const el = document.getElementById(field.name);
                        if (el && data[section.title][field.name] !== undefined) {
                            if (el.type === 'checkbox') el.checked = data[section.title][field.name];
                            else el.value = data[section.title][field.name];
                        }
                    });
                }
                if (section.repeatableGroups) {
                    section.repeatableGroups.forEach(group => {
                        const container = document.querySelectorAll(`h3[textContent="${group.title}"]`)[0].nextSibling; // Asumiendo estructura
                        data[section.title][group.groupName].forEach(instanceData => {
                            addRepeatableInstance(group, container.parentNode, true);
                            group.fields.forEach(field => {
                                const el = container.lastChild.querySelector(`[id*="${field.name}"]`);
                                if (el) el.value = instanceData[field.name];
                            });
                        });
                    });
                }
            });
            updateAll();
        }
    }); // <-- Add this closing parenthesis and curly brace to properly close the DOMContentLoaded event handler
    </script>
</body>
</html>
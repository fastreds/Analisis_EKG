<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formulario Dinámico - AngioTC Cardiaco</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2pdf CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    /* Small extra for touch targets */
    .touch-btn { padding: .9rem 1rem; font-size: 1.05rem; border-radius: .6rem; }
    .input-touch { padding: .7rem .6rem; font-size: 1rem; border-radius: .5rem; }
    .section-card { box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .readonly { background: #f8fafc; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4">
  <div class="max-w-6xl mx-auto">
    <header class="mb-4 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">AngioTC Cardiaco — Formulario Dinámico</h1>
      <div class="space-x-2">
        <button id="btn-scenario-normal" class="touch-btn bg-green-500 text-white">Precargar Normal</button>
        <button id="btn-scenario-severo" class="touch-btn bg-red-600 text-white">Precargar Severo</button>
        <button id="btn-save" class="touch-btn bg-blue-600 text-white">Guardar (local)</button>
        <button id="btn-clear" class="touch-btn bg-gray-300">Limpiar</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section class="lg:col-span-2 space-y-4">
        <div id="form-container"></div>

        <div class="flex gap-2 mt-2">
          <button id="btn-preview" class="touch-btn bg-indigo-600 text-white">Vista previa</button>
          <button id="btn-export" class="touch-btn bg-emerald-600 text-white">Exportar a PDF</button>
          <button id="btn-reset-local" class="touch-btn bg-yellow-500 text-white">Restablecer almacenado</button>
        </div>

      </section>

      <aside class="section-card p-4 bg-white rounded-lg">
        <h2 class="font-medium mb-2">Resumen / CAD-RADS</h2>
        <div class="mb-2">
          <label class="block text-sm">CAD-RADS calculado</label>
          <input id="cad-result" class="input-touch w-full readonly" readonly />
        </div>
        <div class="mb-2">
          <label class="block text-sm">Comentario sugerido</label>
          <textarea id="suggested-comment" class="input-touch w-full readonly" rows="6" readonly></textarea>
        </div>
        <div>
          <h3 class="font-medium">Acciones rápidas</h3>
          <p class="text-sm text-slate-600">Use los botones arriba para precargar escenarios o guardar localmente.</p>
        </div>
      </aside>

      <div class="lg:col-span-3 mt-4">
        <div id="preview-area" class="bg-white p-4 rounded-lg section-card hidden">
          <h3 class="font-semibold">Vista Previa del Informe</h3>
          <div id="report-preview" class="prose max-w-none"></div>
        </div>
      </div>
    </main>

    <footer class="text-xs text-slate-500 mt-6">Generado por herramienta dinámica — Base JSON cargado desde el documento proporcionado.</footer>
  </div>

<script>
/* -----------------------------
   Base JSON (tomado de baseJson.json)
   -----------------------------*/
const baseJson = {"reportStructure":{"sections":[{"title":"Datos del Paciente","fields":[{"name":"nombre","label":"Nombre","type":"text"},{"name":"identificacion","label":"Identificación","type":"text"},{"name":"genero","label":"Género","type":"select","options":["MASCULINO","FEMENINA"]},{"name":"edad","label":"Edad (Años)","type":"number"},{"name":"peso","label":"Peso (Kg)","type":"number"},{"name":"talla","label":"Talla (CM)","type":"number"},{"name":"area_sc","label":"Área SC (m²)","type":"number"},{"name":"fecha_estudio","label":"Fecha del Estudio","type":"date"},{"name":"medico_refiere","label":"Médico que Refiere","type":"text"}]},{"title":"Métodos del Estudio","fields":[{"name":"tomografo","label":"Tomógrafo","type":"text","default":"Canon Aquilion® / 160 cortes"},{"name":"tiempo_rotacion","label":"Tiempo de Rotación","type":"text","default":"0.5/seg"},{"name":"ecg_gating","label":"ECG-gating","type":"text","default":"Retrospectivo (variabilidad FC respiratoria marcada)"},{"name":"medio_contraste","label":"Medio Contraste","type":"text","default":"Ultravist 370"},{"name":"volumen_contraste","label":"Volumen de Medio Contraste (ml)","type":"number","default":85},{"name":"velocidad_infusion","label":"Velocidad de Infusión (ml/s)","type":"number","default":5},{"name":"ritmo_estudio","label":"Ritmo durante el Estudio","type":"text","default":"Ritmo bradicardia sinusal"}]},{"title":"Motivo de Estudio y Generalidades","fields":[{"name":"motivo","label":"Descripción de la Referencia","type":"textarea"},{"name":"consentimiento","label":"Consentimiento Informado","type":"checkbox","labelText":"Firmado"},{"name":"tolerancia","label":"Tolerancia al Estudio","type":"text","default":"Buena tolerancia al estudio, sin reacciones adversas al medio contraste."},{"name":"fc","label":"FC durante el Estudio","type":"text","default":"Paciente con FC de 45-55 lpm durante el estudio. Se utilizó una dosis de nitroglicerina sublingual."},{"name":"analisis","label":"Análisis de Imágenes","type":"text","default":"Análisis de imágenes fue por medio de estación de trabajo Vitrea®, todas las mediciones finales incluyendo cortes multiplanares y reconstrucción 3D."},{"name":"calidad","label":"Calidad de Estudio","type":"select","options":["Buena","Aceptable","Limitada"]}]},{"title":"Anatomía Cardiovascular","fields":[{"name":"venas_cavas","label":"Venas Cavas","type":"text","default":"Ambas no dilatadas drenando en la aurícula derecha"},{"name":"auricula_derecha","label":"Aurícula Derecha","type":"text","default":"No dilatada"},{"name":"septum_interauricular","label":"Septum Interauricular","type":"text","default":"No se visualizan defectos"},{"name":"seno_coronario","label":"Seno Coronario","type":"text","default":"Drenando a la AD en forma habitual sin dilatación o anomalías"},{"name":"valvula_tricuspide","label":"Válvula Tricúspide","type":"text","default":"No se visualizan defectos por este método"},{"name":"ventriculo_derecho","label":"Ventrículo Derecho","type":"text","default":"No dilatado ni hipertrófico"},{"name":"arteria_pulmonar","label":"Arteria Pulmonar","type":"text","default":"Diámetro Normal"},{"name":"venas_pulmonares","label":"Venas Pulmonares","type":"text","default":"Cuatro drenando a la aurícula izquierda, dos derechas y dos izquierdas"},{"name":"auricula_izquierda","label":"Aurícula Izquierda","type":"text","default":"No se observan trombos en la orejuela izquierda, ni masas o lesiones intracardiacas."},{"name":"ventriculo_izquierdo","label":"Ventrículo Izquierdo","type":"text","default":"No dilatado con hipertrofia concéntrica leve. Motilidad global y regional conservada. FEVI normal 70%."},{"name":"hallazgos_extracardiacos","label":"Hallazgos Extracardiacos","type":"text","default":"Hernia hiatal pequeña"}]},{"title":"Válvula Aórtica","fields":[{"name":"cuspides","label":"Cúspides","type":"text","default":"3 cúspides de conformación Normal"},{"name":"calcificaciones_valvula","label":"Calcificaciones","type":"text"},{"name":"morfologia_anillo","label":"Morfología del Anillo Aórtico","type":"select","options":["Elíptica","Circular"]},{"name":"diametro_menor_anillo","label":"Diámetro Menor del Anillo (mm)","type":"number"},{"name":"diametro_mayor_anillo","label":"Diámetro Mayor del Anillo (mm)","type":"number"}]},{"title":"Diámetros de la Aorta","fields":[{"name":"senos_valsalva_diametro","label":"Senos de Valsalva (mm)","type":"number"},{"name":"senos_valsalva_indexado","label":"Senos de Valsalva Indexado (mm/m² SC)","type":"number"},{"name":"senos_valsalva_observaciones","label":"Observaciones Senos de Valsalva","type":"text","default":"NORMAL"},{"name":"union_sinotubular_diametro","label":"Unión Sinotubular (mm)","type":"number"},{"name":"union_sinotubular_indexado","label":"Unión Sinotubular Indexado (mm/m² SC)","type":"number"},{"name":"union_sinotubular_observaciones","label":"Observaciones Unión Sinotubular","type":"text","default":"NORMAL"},{"name":"tubular_ascendente_diametro","label":"Porción Tubular Ascendente (mm)","type":"number"},{"name":"tubular_ascendente_indexado","label":"Porción Tubular Ascendente Indexado (mm/m² SC)","type":"number"},{"name":"tubular_ascendente_observaciones","label":"Observaciones Porción Tubular Ascendente","type":"text","default":"NORMAL (medición a 40 mm del anillo aórtico)"}]},{"title":"Score de Calcio Coronario","fields":[{"name":"calcio_total","label":"Total (Agatston)","type":"number","default":0},{"name":"calcio_tci","label":"TCI","type":"number","default":0},{"name":"calcio_ada","label":"ADA","type":"number","default":0},{"name":"calcio_acd","label":"ACD","type":"number","default":0},{"name":"calcio_acx","label":"ACX","type":"number","default":0}]},{"title":"Arteriografía Coronaria No Invasiva - Arteria Coronaria Izquierda","fields":[{"name":"tci_longitud","label":"Tronco Coronario Izquierdo - Longitud (mm)","type":"number","default":13},{"name":"tci_nacimiento","label":"Nacimiento","type":"text","default":"0% POR DIÁMETRO 0% POR ÁREA LUMINAL MÍNIMA"},{"name":"tci_ateromatosis","label":"Ateromatosis","type":"text"},{"name":"tci_compromiso_luminal","label":"Compromiso Luminal","type":"text"},{"name":"tci_obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"tci_termina_en","label":"Termina en","type":"text"},{"name":"tci_artefacto","label":"Presencia de Artefacto","type":"text"}],"repeatableGroups":[{"groupName":"ada_segments","title":"Arteria Descendente Anterior (ADA) - Segmentos","repeatable":true,"fields":[{"name":"segmento","label":"Segmento","type":"select","options":["Proximal","Medio","Distal"]},{"name":"calibre_desarrollo","label":"Calibre y Desarrollo","type":"text"},{"name":"ateromatosis","label":"Ateromatosis","type":"text"},{"name":"compromiso_luminal","label":"Compromiso Luminal","type":"text","default":"0%"},{"name":"obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"puente_intramiocardico","label":"Puente Intramiocárdico","type":"text"},{"name":"artefacto","label":"Presencia de Artefacto","type":"text"}]},{"groupName":"ada_ramas","title":"Ramas de la ADA","repeatable":true,"fields":[{"name":"rama","label":"Rama","type":"select","options":["Primera Rama Diagonal","Segunda Rama Diagonal","Tercera Rama Diagonal"]},{"name":"origen","label":"Origen","type":"text"},{"name":"calibre_desarrollo","label":"Calibre y Desarrollo","type":"text"},{"name":"ateromatosis","label":"Ateromatosis","type":"text","default":"0%"},{"name":"compromiso_luminal","label":"Compromiso Luminal","type":"text"},{"name":"obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"artefacto","label":"Presencia de Artefacto","type":"text"}]},{"groupName":"ramus_intermedio","title":"Arteria del Ramus Intermedio","repeatable":false,"fields":[{"name":"calibre_desarrollo","label":"Calibre y Desarrollo","type":"text"},{"name":"ateromatosis","label":"Ateromatosis","type":"text"},{"name":"compromiso_luminal","label":"Compromiso Luminal","type":"text","default":"0%"},{"name":"obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"artefacto","label":"Presencia de Artefacto","type":"text"}]},{"groupName":"acx_segments","title":"Arteria Circunfleja (ACX) - Segmentos","repeatable":true,"fields":[{"name":"segmento","label":"Segmento","type":"select","options":["Proximal","Medio","Distal"]},{"name":"calibre_desarrollo","label":"Calibre y Desarrollo","type":"text"},{"name":"ateromatosis","label":"Ateromatosis","type":"text","default":"0%"},{"name":"compromiso_luminal","label":"Compromiso Luminal","type":"text"},{"name":"obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"artefacto","label":"Presencia de Artefacto","type":"text"}]},{"groupName":"acx_ramas","title":"Ramas de la ACX","repeatable":true,"fields":[{"name":"rama","label":"Rama","type":"select","options":["Primera Rama Marginal Obtusa","Segunda Rama Marginal Obtusa"]},{"name":"calibre_desarrollo","label":"Calibre y Desarrollo","type":"text"},{"name":"ateromatosis","label":"Ateromatosis","type":"text","default":"0%"},{"name":"compromiso_luminal","label":"Compromiso Luminal","type":"text"},{"name":"obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"artefacto","label":"Presencia de Artefacto","type":"text"}]}]},{"title":"Arteriografía Coronaria No Invasiva - Arteria Coronaria Derecha","fields":[{"name":"acd_dominancia","label":"Dominancia","type":"select","options":["Dominante","No Dominante","Co-Dominante"]},{"name":"acd_ostium","label":"Ostium y Nacimiento","type":"text","default":"Normal. Trayecto normal"}],"repeatableGroups":[{"groupName":"acd_segments","title":"Arteria Coronaria Derecha (ACD) - Segmentos","repeatable":true,"fields":[{"name":"segmento","label":"Segmento","type":"select","options":["Proximal","Medio","Distal"]},{"name":"ateromatosis","label":"Ateromatosis","type":"text","default":"0%"},{"name":"compromiso_luminal","label":"Compromiso Luminal","type":"text"},{"name":"obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"artefacto","label":"Presencia de Artefacto","type":"text"}]},{"groupName":"acd_ramas","title":"Ramas de la Arteria Coronaria Derecha","repeatable":true,"fields":[{"name":"rama","label":"Rama","type":"select","options":["Arteria Conal y Arteria para el Nodo AV","Rama Marginal Aguda","Rama Interventricular Posterior","Rama Posterolateral"]},{"name":"origen","label":"Origen","type":"text"},{"name":"calibre_desarrollo","label":"Calibre y Desarrollo","type":"text"},{"name":"ateromatosis","label":"Ateromatosis","type":"text","default":"0%"},{"name":"compromiso_luminal","label":"Compromiso Luminal","type":"text"},{"name":"obstruccion","label":"% de Obstrucción","type":"number","default":0,"suggestComment":true},{"name":"artefacto","label":"Presencia de Artefacto","type":"text"}]}]},{"title":"Conclusiones Angio TC Cardiaco Multidetector","fields":[{"name":"conclusiones","label":"Conclusiones Generales","type":"textarea","default":"• Implantación normal de las Arterias Coronarias.\n• El Tronco Coronario Izquierdo no presenta ateromatosis.\n• La Arteria Descendente Anterior es un vaso que no presenta ateromatosis.\n• La Arteria del Ramus Intermedio es un vaso que no presenta ateromatosis.\n• La Arteria Circunfleja es un vaso no dominante que no presenta ateromatosis.\n• La Arteria Coronaria Derecha es un vaso dominante que presenta ateromatosis mixta y compromiso luminal moderado a nivel proximal.\n• Puente Miocárdico a nivel del tercio medio/proximal/distal de la ADA.\n• Ventrículo Izquierdo no dilatado con hipertrofia concéntrica leve. Motilidad global y regional conservada. FEVI normal 70%.\n• Ventrículo Derecho no dilatado ni hipertrófico.\n• Aorta Torácica sin dilatación ni ateromatosis.\n• Aorta Torácica con dilatación, en ningún caso en rango aneurismático con ateromatosis moderada.\n• Drenaje Venoso sistémico y pulmonar normal.\n• Concordancia AV y VA, sin otros defectos congénitos evaluables por este método."},{"name":"cad_rads","label":"CAD-RADS","type":"select","options":["CAD-RADS:0","CAD-RADS:1","CAD-RADS:2","CAD-RADS:3","CAD-RADS:4a","CAD-RADS:4b","CAD-RADS:5"],"descriptions":{"CAD-RADS:0":"según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556.","CAD-RADS:1":"según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556.). Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa.","CAD-RADS:2":"según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa.","CAD-RADS:3":"según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.","CAD-RADS:4a":"según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.","CAD-RADS:4b":"según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional.","CAD-RADS:5":"según la clasificación del documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556. Con este resultado se recomienda el control óptimo de factores de riesgo modificables generadores de progresión de placa y la correlación clínica y funcional."}},{"name":"cad_rads_display","label":"CAD-RADS Calculado","type":"text","readonly":true,"description":"Clasificación según documento de consenso de expertos SCCT, ACR, NASCI y ACC (JCardiovasc Comput Tomogr. 2022 (16) 537-556)"}]}]}};

/* -----------------------------
   Utilities and state
   -----------------------------*/
const state = { values: {}, repeatableCounters: {} };
const storageKey = 'angio_form_v1';

function saveLocal() {
  localStorage.setItem(storageKey, JSON.stringify(state.values));
  alert('Guardado localmente');
}
function loadLocal() {
  const s = localStorage.getItem(storageKey);
  if (s) state.values = JSON.parse(s);
}
function resetLocal() {
  localStorage.removeItem(storageKey);
  state.values = {};
  renderForm();
}

/* -----------------------------
   Rendering engine
   -----------------------------*/
const formContainer = document.getElementById('form-container');

function el(tag, attrs = {}, ...children) {
  const node = document.createElement(tag);
  for (let k in attrs) {
    if (k === 'class') node.className = attrs[k];
    else if (k.startsWith('on')) node.addEventListener(k.substring(2), attrs[k]);
    else node.setAttribute(k, attrs[k]);
  }
  children.flat().forEach(c => {
    if (typeof c === 'string') node.appendChild(document.createTextNode(c));
    else if (c) node.appendChild(c);
  });
  return node;
}

function getValue(path) {
  return state.values[path];
}
function setValue(path, val) {
  state.values[path] = val;
  computeCadRads();
}

function renderField(field, prefix = '') {
  const id = prefix + field.name;
  const wrapper = el('div', { class: 'mb-3' });
  const label = el('label', { class: 'block text-sm font-medium mb-1' }, field.label || field.name);
  let input;
  const commonClass = 'input-touch w-full border border-slate-200';
  if (field.type === 'text' || field.type === 'number' || field.type === 'date') {
    input = el('input', { id, class: commonClass, type: field.type === 'number' ? 'number' : field.type === 'date' ? 'date' : 'text' });
    if (field.default !== undefined) input.value = field.default;
    const existing = getValue(id);
    if (existing !== undefined) input.value = existing;
    input.addEventListener('input', e => setValue(id, e.target.value));
  } else if (field.type === 'textarea') {
    input = el('textarea', { id, class: commonClass, rows: 3 }, '');
    if (field.default) input.value = field.default;
    const existing = getValue(id);
    if (existing !== undefined) input.value = existing;
    input.addEventListener('input', e => setValue(id, e.target.value));
  } else if (field.type === 'select') {
    input = el('select', { id, class: commonClass }, '');
    const opts = field.options || [];
    opts.forEach(o => input.appendChild(el('option', { value: o }, o)));
    if (field.default) input.value = field.default;
    const existing = getValue(id);
    if (existing !== undefined) input.value = existing;
    input.addEventListener('change', e => setValue(id, e.target.value));
  } else if (field.type === 'checkbox') {
    input = el('input', { id, class: 'mr-2', type: 'checkbox' });
    const existing = getValue(id);
    if (existing !== undefined) input.checked = existing;
    if (field.default) input.checked = !!field.default;
    input.addEventListener('change', e => setValue(id, e.target.checked));
    const flex = el('div', { class: 'flex items-center' }, input, el('span', {}, field.labelText || field.label));
    wrapper.appendChild(flex);
    return wrapper;
  }
  wrapper.appendChild(label);
  wrapper.appendChild(input);

  // If field suggests comment, add listener
  if (field.suggestComment) {
    input.addEventListener('input', e => onObstructionChange(prefix + field.name, e.target.value));
  }

  return wrapper;
}

function renderRepeatable(group, prefix) {
  const container = el('div', { class: 'mb-4 p-3 border rounded-lg bg-slate-50' });
  container.appendChild(el('h4', { class: 'font-semibold mb-2' }, group.title));
  const list = el('div', { id: `${prefix}${group.groupName}_list` });
  container.appendChild(list);
  const addBtn = el('button', { class: 'touch-btn bg-sky-500 text-white mt-2', onclick: () => addRepeat(group, prefix) }, 'Agregar');
  container.appendChild(addBtn);
  // Load existing
  const existing = state.values[`${prefix}${group.groupName}_count`] || 0;
  for (let i=0;i<existing;i++) addRepeat(group, prefix, false);
  return container;
}

function addRepeat(group, prefix, increaseCount = true) {
  state.repeatableCounters[prefix+group.groupName] = (state.repeatableCounters[prefix+group.groupName] || 0) + 1;
  const idx = state.repeatableCounters[prefix+group.groupName];
  if (increaseCount) state.values[`${prefix}${group.groupName}_count`] = idx;
  const block = el('div', { class: 'mb-3 p-3 bg-white rounded-lg border' });
  block.appendChild(el('div', { class: 'flex justify-between items-center mb-2' }, el('strong', {}, `${group.title} #${idx}`), el('button', { class: 'text-red-600', onclick: ()=>{ block.remove(); computeCadRads(); } }, 'Eliminar')));
  group.fields.forEach(f => block.appendChild(renderField(f, `${prefix}${group.groupName}_${idx}_`)));
  const list = document.getElementById(`${prefix}${group.groupName}_list`);
  list.appendChild(block);
}

function renderSection(section, index) {
  const sec = el('section', { class: 'bg-white p-4 rounded-lg section-card mb-4' });
  sec.appendChild(el('h3', { class: 'text-lg font-medium mb-3' }, section.title));
  (section.fields || []).forEach(f => sec.appendChild(renderField(f, section.title.replace(/\s+/g,'_') + '_')));
  (section.repeatableGroups || []).forEach(g => sec.appendChild(renderRepeatable(g, section.title.replace(/\s+/g,'_') + '_')));
  return sec;
}

function renderForm() {
  formContainer.innerHTML = '';
  baseJson.reportStructure.sections.forEach((s, i) => formContainer.appendChild(renderSection(s, i)));
}

/* -----------------------------
   Obstruction suggestion logic
   -----------------------------*/
function onObstructionChange(fieldPath, value) {
  const num = Number(value);
  // set in state
  setValue(fieldPath, value);
  // simple suggestion algorithm
  const commentArea = document.getElementById('suggested-comment');
  let comment = getValue('Conclusiones Angio TC Cardiaco Multidetector_conclusiones') || '';
  const sug = generateSuggestion(fieldPath, num);
  if (sug) comment = sug + "\n" + comment;
  commentArea.value = comment;
}

function generateSuggestion(fieldId, pct) {
  if (!Number.isFinite(pct)) return '';
  if (pct === 100) return `Oclusión total (100%) en ${fieldId.replace(/_/g,' ')}.`;
  if (pct >= 70) return `Estenosis severa (${pct}%) en ${fieldId.replace(/_/g,' ')} — considerar evaluación funcional/angiografía coronaria.`;
  if (pct >= 50) return `Estenosis moderada (${pct}%) en ${fieldId.replace(/_/g,' ')} — correlacionar con síntomas y pruebas funcionales.`;
  if (pct >= 25) return `Estenosis leve-moderada (${pct}%) en ${fieldId.replace(/_/g,' ')}.`;
  if (pct > 0) return `Placa non-obstructiva (${pct}%) en ${fieldId.replace(/_/g,' ')}.`;
  return '';
}

/* -----------------------------
   CAD-RADS algorithm (simplified)
   - Best effort: maps highest stenosis to CAD-RADS.
   - Modifiers: left main >=50% -> 4b, multivaso >=70% -> 4b, occlusion 100 -> 5
   NOTE: Este es un algoritmo simplificado. Ver normativa SCCT/ACR para definiciones completas.
   -----------------------------*/
function computeCadRads() {
  // collect all obstruction fields from state
  const entries = Object.entries(state.values).filter(([k,v]) => k.toLowerCase().includes('obstruccion') || k.toLowerCase().includes('tci_obstruccion'));
  let maxPct = -1;
  let leftMainPct = -1;
  let multivaso70count = 0;
  let occlusion = false;
  for (const [k,v] of entries) {
    const n = Number(v);
    if (!isNaN(n)) {
      if (n > maxPct) maxPct = n;
      if (k.toLowerCase().includes('tci') && n >= 0) leftMainPct = Math.max(leftMainPct, n);
      if (n >= 70) multivaso70count++;
      if (n === 100) occlusion = true;
    }
  }
  let cad = 'CAD-RADS:0';
  if (occlusion) cad = 'CAD-RADS:5';
  else if (leftMainPct >= 50) cad = 'CAD-RADS:4b';
  else if (maxPct >= 70 && multivaso70count >= 2) cad = 'CAD-RADS:4b';
  else if (maxPct >= 70) cad = 'CAD-RADS:4a';
  else if (maxPct >= 50) cad = 'CAD-RADS:3';
  else if (maxPct >= 25) cad = 'CAD-RADS:2';
  else if (maxPct >= 1) cad = 'CAD-RADS:1';
  else cad = 'CAD-RADS:0';

  document.getElementById('cad-result').value = cad;
  state.values['Conclusiones Angio TC Cardiaco Multidetector_cad_rads_display'] = cad;
}

/* -----------------------------
   Preview and export
   -----------------------------*/
function generateReportHTML() {
  const preview = document.getElementById('report-preview');
  preview.innerHTML = '';
  baseJson.reportStructure.sections.forEach(sec => {
    const h = document.createElement('h4'); h.textContent = sec.title; preview.appendChild(h);
    const ul = document.createElement('div'); ul.className = 'mb-3';
    (sec.fields || []).forEach(f => {
      const key = sec.title.replace(/\s+/g,'_') + '_' + f.name;
      const val = state.values[key] !== undefined ? state.values[key] : (f.default || '');
      const p = document.createElement('p'); p.innerHTML = `<strong>${f.label}:</strong> ${sanitize(String(val))}`;
      ul.appendChild(p);
    });
    (sec.repeatableGroups || []).forEach(g => {
      // look for count
      const count = state.values[`${sec.title.replace(/\s+/g,'_')}_${g.groupName}_count`] || 0;
      for (let i=1;i<=count;i++) {
        const subh = document.createElement('h5'); subh.textContent = `${g.title} #${i}`; ul.appendChild(subh);
        g.fields.forEach(f => {
          const key = `${sec.title.replace(/\s+/g,'_')}_${g.groupName}_${i}_` + f.name;
          const val = state.values[key] !== undefined ? state.values[key] : (f.default || '');
          const p = document.createElement('p'); p.innerHTML = `<strong>${f.label}:</strong> ${sanitize(String(val))}`;
          ul.appendChild(p);
        });
      }
    });
    preview.appendChild(ul);
  });
  // CAD-RADS and suggested comments
  const cad = document.getElementById('cad-result').value;
  preview.appendChild(el('hr'));
  preview.appendChild(el('p', {}, el('strong', {}, 'CAD-RADS: '), cad));
  const sug = document.getElementById('suggested-comment').value;
  if (sug) preview.appendChild(el('p', {}, el('strong', {}, 'Comentario sugerido: '), el('div', {}, sug)));
  return preview;
}

function sanitize(s) { return s.replace(/</g,'&lt;'); }

/* -----------------------------
   Scenarios
   -----------------------------*/
function loadScenarioNormal() {
  // small set of typical normals
  state.values = {
    'Datos_del_Paciente_nombre': 'Paciente Ejemplo',
    'Datos_del_Paciente_identificacion': '0000000',
    'Datos_del_Paciente_genero': 'MASCULINO',
    'Datos_del_Paciente_edad': '60',
    'Datos_del_Paciente_peso': '78',
    'Datos_del_Paciente_talla': '170',
    'Datos_del_Paciente_area_sc': '1.8',
    'Datos_del_Paciente_fecha_estudio': new Date().toISOString().slice(0,10),
    'Métodos_del_Estudio_tomografo': 'Canon Aquilion® / 160 cortes',
    'Arteriografía_Coronaria_No_Invasiva_-_Arteria_Coronaria_Izquierda_tci_obstruccion': 0,
    'Arteriografía_Coronaria_No_Invasiva_-_Arteria_Coronaria_Derecha_acd_segments_1_obstruccion': 0
  };
  renderForm();
  computeCadRads();
}
function loadScenarioSevere() {
  state.values = {
    'Datos_del_Paciente_nombre': 'Paciente Severamente Enf.',
    'Datos_del_Paciente_identificacion': '9999999',
    'Datos_del_Paciente_genero': 'FEMENINA',
    'Datos_del_Paciente_edad': '72',
    'Datos_del_Paciente_peso': '82',
    'Datos_del_Paciente_talla': '160',
    'Datos_del_Paciente_area_sc': '1.7',
    'Datos_del_Paciente_fecha_estudio': new Date().toISOString().slice(0,10),
    'Arteriografía_Coronaria_No_Invasiva_-_Arteria_Coronaria_Izquierda_tci_obstruccion': 55,
    'Arteriografía_Coronaria_No_Invasiva_-_Arteria_Coronaria_Izquierda_ada_segments_1_obstruccion': 80,
    'Arteriografía_Coronaria_No_Invasiva_-_Arteria_Coronaria_Izquierda_acx_segments_1_obstruccion': 75,
  };
  renderForm();
  computeCadRads();
}

/* -----------------------------
   Events
   -----------------------------*/
document.getElementById('btn-scenario-normal').addEventListener('click', ()=>{ loadScenarioNormal(); saveLocal(); });
document.getElementById('btn-scenario-severo').addEventListener('click', ()=>{ loadScenarioSevere(); saveLocal(); });
document.getElementById('btn-save').addEventListener('click', saveLocal);
document.getElementById('btn-clear').addEventListener('click', ()=>{ if(confirm('Limpiar formulario?')){ state.values={}; renderForm(); computeCadRads(); }});
document.getElementById('btn-reset-local').addEventListener('click', ()=>{ if(confirm('Borrar almacenado local permanentemente?')) resetLocal(); });

document.getElementById('btn-preview').addEventListener('click', ()=>{
  const area = document.getElementById('preview-area');
  area.classList.remove('hidden');
  generateReportHTML();
});

document.getElementById('btn-export').addEventListener('click', ()=>{
  const preview = generateReportHTML();
  // Clone to printable area
  const element = preview.cloneNode(true);
  element.style.background = 'white';
  const opt = {
    margin:       10,
    filename:     `angioTC_informe_${new Date().toISOString().slice(0,10)}.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
});

/* -----------------------------
   Init
   -----------------------------*/
loadLocal();
renderForm();
computeCadRads();

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporteador Coronario por Zonas Anatómicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Medical Professional -->
    <!-- Application Structure Plan: La nueva estructura mantiene el diseño de dos columnas pero invierte el flujo de trabajo. La columna derecha (panel de control) es ahora el punto de partida. El usuario selecciona la zona anatómica y el grado de la lesión desde los menús desplegables. Al guardar, un marcador aparece automáticamente en una ubicación pre-calibrada dentro de la zona correspondiente en el diagrama de la izquierda. Esta arquitectura está optimizada para la velocidad y la estandarización, ya que elimina la variabilidad del clic manual y guía al usuario a través de un proceso de reporte estructurado. La "calibración" se maneja a través de un objeto JavaScript que mapea cada arteria a coordenadas específicas, actuando como una librería interna de zonas. -->
    <!-- Visualization & Content Choices: Report Info: Ubicación y severidad de la lesión. -> Goal: Graficar rápidamente un hallazgo de un reporte en la zona anatómica correcta. -> Viz/Presentation Method: El formulario de entrada es el método principal de interacción. El diagrama es puramente una visualización de salida. Se han añadido dos leyendas: una para los colores de las zonas anatómicas (basada en la nueva imagen) y otra para los colores de los marcadores de lesión (basada en CAD-RADS). -> Interaction: La interacción principal es la selección en los menús desplegables. El hover sobre los marcadores y la lista de resumen se mantiene para una fácil correlación entre los datos gráficos y textuales. -> Justification: Este modelo es superior para la documentación rápida y consistente. Al predefinir las zonas, se asegura que todos los reportes usen las mismas ubicaciones de referencia, mejorando la estandarización y la claridad. -> Library/Method: HTML/CSS (Tailwind), JavaScript para la lógica de zonas predefinidas y la renderización, y html2canvas para la exportación. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .marker {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            border: 3px solid white;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            z-index: 10;
        }
        .marker.highlight {
            transform: translate(-50%, -50%) scale(1.3);
            border-color: #007bff;
            z-index: 20;
        }
        .tooltip {
            visibility: hidden;
            width: 180px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 30;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .marker:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                <h1 class="text-2xl font-bold text-gray-900">Reporteador Coronario por Zonas Anatómicas</h1>
                <p class="text-sm text-gray-500">Herramienta para graficar lesiones coronarias a partir de un reporte.</p>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div id="main-content" class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">Diagrama Coronario</h2>
                     <div id="instruction" class="mb-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg">
                        <p><span class="font-bold">Instrucciones:</span> Seleccione una arteria y un grado de lesión en el panel de control para graficar un hallazgo.</p>
                    </div>
                    <div id="diagram-container" class="relative w-full max-w-3xl mx-auto border-2 border-gray-300 rounded-lg overflow-hidden">
                        <img id="coronary-img" src="esquemaCoronarioColores.png" alt="Diagrama del árbol coronario con zonas de colores" class="w-full h-auto block" draggable="false">
                        <div id="markers-container"></div>
                    </div>
                </div>
                
                <div class="lg:col-span-1 space-y-8">
                    <div id="form-container" class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Añadir Hallazgo</h2>
                        <form id="finding-form" class="space-y-4">
                            <div>
                                <label for="artery" class="block text-sm font-medium text-gray-700">Arteria / Segmento</label>
                                <select id="artery" name="artery" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <optgroup label="Tronco Coronario Izquierdo">
                                        <option value="TCI">TCI (Rojo)</option>
                                    </optgroup>
                                    <optgroup label="Arteria Descendente Anterior">
                                        <option value="LAD">DA General (Azul)</option>
                                        <option value="DIAG">Ramas Diagonales (Verde)</option>
                                    </optgroup>
                                    <optgroup label="Arteria Circunfleja">
                                        <option value="LCX">CX General (Morado)</option>
                                        <option value="MARG">Ramas Marginales (Naranja)</option>
                                    </optgroup>
                                    <optgroup label="Arteria Coronaria Derecha">
                                        <option value="RCA">ACD General (Magenta)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label for="cads-rads" class="block text-sm font-medium text-gray-700">Grado CAD-RADS</label>
                                <select id="cads-rads" name="cads-rads" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="1">1: Estenosis mínima (1-24%)</option>
                                    <option value="2">2: Estenosis leve (25-49%)</option>
                                    <option value="3">3: Estenosis moderada (50-69%)</option>
                                    <option value="4">4: Estenosis severa (70-99%)</option>
                                    <option value="5">5: Oclusión total (100%)</option>
                                </select>
                            </div>
                            <button type="submit" id="save-finding-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Añadir al Gráfico</button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Leyenda de Zonas</h2>
                        <div class="space-y-3">
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full mr-3" style="background-color: red;"></div><span>Tronco Coronario Izquierdo (TCI)</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full mr-3" style="background-color: blue;"></div><span>A. Descendente Anterior (DA)</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full mr-3" style="background-color: green;"></div><span>Ramas Diagonales</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full mr-3" style="background-color: purple;"></div><span>A. Circunfleja (CX)</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full mr-3" style="background-color: orange;"></div><span>Ramas Marginales</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full mr-3" style="background-color: magenta;"></div><span>A. Coronaria Derecha (ACD)</span></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Simbología de Lesión (CAD-RADS)</h2>
                        <div class="space-y-3">
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-green-500 mr-3 border-2 border-white shadow-md"></div><span><b>1:</b> Estenosis mínima</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-yellow-400 mr-3 border-2 border-white shadow-md"></div><span><b>2:</b> Estenosis leve</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-orange-500 mr-3 border-2 border-white shadow-md"></div><span><b>3:</b> Estenosis moderada</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-red-600 mr-3 border-2 border-white shadow-md"></div><span><b>4:</b> Estenosis severa</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-black mr-3 border-2 border-white shadow-md"></div><span><b>5:</b> Oclusión total</span></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Resumen de Hallazgos</h2>
                        <div id="findings-list" class="space-y-3">
                            <p class="text-gray-500">Aún no se han añadido hallazgos.</p>
                        </div>
                        <div class="mt-6 flex space-x-2">
                            <button id="export-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Exportar Reporte</button>
                            <button id="clear-btn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Limpiar Todo</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markersContainer = document.getElementById('markers-container');
            const form = document.getElementById('finding-form');
            const findingsList = document.getElementById('findings-list');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');

            let findings = [];
            let findingIdCounter = 0;

            const arteryZones = {
                'TCI': { x: 48, y: 25, name: 'Tronco Coronario Izquierdo' },
                'LAD': { x: 50, y: 45, name: 'A. Descendente Anterior' },
                'DIAG': { x: 55, y: 60, name: 'Ramas Diagonales' },
                'LCX': { x: 38, y: 40, name: 'A. Circunfleja' },
                'MARG': { x: 30, y: 65, name: 'Ramas Marginales' },
                'RCA': { x: 70, y: 55, name: 'A. Coronaria Derecha' }
            };

            const cadsColors = {
                '1': 'bg-green-500',
                '2': 'bg-yellow-400',
                '3': 'bg-orange-500',
                '4': 'bg-red-600',
                '5': 'bg-black',
            };
            
            const cadsDescriptions = {
                '1': 'CAD-RADS 1: Estenosis mínima (1-24%)',
                '2': 'CAD-RADS 2: Estenosis leve (25-49%)',
                '3': 'CAD-RADS 3: Estenosis moderada (50-69%)',
                '4': 'CAD-RADS 4: Estenosis severa (70-99%)',
                '5': 'CAD-RADS 5: Oclusión total (100%)'
            };

            function renderFindings() {
                markersContainer.innerHTML = '';
                findingsList.innerHTML = '';

                if (findings.length === 0) {
                    findingsList.innerHTML = '<p class="text-gray-500">Aún no se han añadido hallazgos.</p>';
                } else {
                    findings.forEach(finding => {
                        const marker = document.createElement('div');
                        marker.className = `marker ${cadsColors[finding.cadsRads]}`;
                        marker.style.left = `${finding.x}%`;
                        marker.style.top = `${finding.y}%`;
                        marker.dataset.id = finding.id;
                        marker.innerHTML = `
                            ${finding.cadsRads}
                            <span class="tooltip">${finding.arteryName}: ${cadsDescriptions[finding.cadsRads]}</span>
                        `;
                        markersContainer.appendChild(marker);

                        const listItem = document.createElement('div');
                        listItem.className = 'p-3 border rounded-md hover:bg-gray-50 cursor-pointer flex justify-between items-center';
                        listItem.dataset.id = finding.id;
                        listItem.innerHTML = `
                            <div>
                                <p class="font-semibold">${finding.arteryName}</p>
                                <p class="text-sm text-gray-600">${cadsDescriptions[finding.cadsRads]}</p>
                            </div>
                            <button class="delete-finding-btn text-red-500 hover:text-red-700 text-xs font-semibold" data-id="${finding.id}">X</button>
                        `;
                        findingsList.appendChild(listItem);
                    });
                }
                addEventListenersToItems();
            }

            function addEventListenersToItems() {
                document.querySelectorAll('.marker, [data-id]').forEach(el => {
                    el.addEventListener('mouseenter', handleMouseEnter);
                    el.addEventListener('mouseleave', handleMouseLeave);
                });
                
                document.querySelectorAll('.delete-finding-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const idToDelete = parseInt(e.target.dataset.id, 10);
                        findings = findings.filter(f => f.id !== idToDelete);
                        renderFindings();
                    });
                });
            }
            
            function handleMouseEnter(e) {
                const id = e.currentTarget.dataset.id;
                if (!id) return;
                document.querySelectorAll(`[data-id="${id}"]`).forEach(el => el.classList.add('highlight'));
            }

            function handleMouseLeave(e) {
                const id = e.currentTarget.dataset.id;
                 if (!id) return;
                document.querySelectorAll(`[data-id="${id}"]`).forEach(el => el.classList.remove('highlight'));
            }

            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const arteryKey = form.elements['artery'].value;
                const zone = arteryZones[arteryKey];

                const newFinding = {
                    id: findingIdCounter++,
                    arteryKey: arteryKey,
                    arteryName: zone.name,
                    cadsRads: form.elements['cads-rads'].value,
                    x: zone.x,
                    y: zone.y,
                };

                findings.push(newFinding);
                renderFindings();
                form.reset();
            });
            
            clearBtn.addEventListener('click', () => {
                if (findings.length > 0 && confirm('¿Estás seguro de que deseas eliminar todos los hallazgos?')) {
                    findings = [];
                    renderFindings();
                }
            });

            exportBtn.addEventListener('click', () => {
                const contentToExport = document.getElementById('main-content');
                html2canvas(contentToExport, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'esquemaCoronarioColores.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            });

            renderFindings();
        });
    </script>
</body>
</html>

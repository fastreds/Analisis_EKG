
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Interactivo de Árbol Coronario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: Se ha diseñado una estructura de dos columnas para optimizar el flujo de trabajo del especialista. La columna izquierda, más ancha, se dedica exclusivamente al diagrama visual del árbol coronario, permitiendo una interacción directa y sin distracciones. La columna derecha actúa como un panel de control y resumen, consolidando la entrada de datos (formulario), la referencia visual (simbología) y la salida de información (resumen de hallazgos). Esta disposición permite al usuario añadir un hallazgo y ver el resultado actualizado en el resumen de forma simultánea, mejorando la eficiencia y reduciendo la carga cognitiva. La interacción clave es el "clic para añadir" en el diagrama, que preselecciona la ubicación y enfoca al usuario en el formulario para completar los detalles, creando un proceso guiado e intuitivo. -->
    <!-- Visualization & Content Choices: Report Info: Grado de obstrucción (CAD-RADS) en segmentos arteriales. -> Goal: Identificar rápidamente la ubicación y severidad de las lesiones. -> Viz/Presentation Method: Se utilizan marcadores circulares de colores sobre el diagrama. El color indica el grado de estenosis y un número en el interior muestra el valor CAD-RADS exacto, ofreciendo redundancia visual para una claridad máxima. -> Interaction: Al pasar el cursor sobre un marcador, aparece un tooltip con detalles. Al pasar el cursor sobre un hallazgo en la lista de resumen, el marcador correspondiente en el diagrama se resalta. Esta vinculación interactiva conecta la representación gráfica con los datos textuales. -> Justification: Este enfoque dual (color + número + tooltip + resaltado) es superior a un simple punto de color, ya que proporciona información detallada de forma inmediata y contextual, haciendo el diagnóstico mucho más fácil de comprender. -> Library/Method: HTML/CSS (Tailwind) para los marcadores y la interfaz, JavaScript para la interactividad y la lógica de estado, y la librería html2canvas para la funcionalidad de exportación. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .marker {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            z-index: 10;
        }
        .marker.highlight {
            transform: translate(-50%, -50%) scale(1.3);
            border-color: #007bff;
            z-index: 20;
        }
        .tooltip {
            visibility: hidden;
            width: 180px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 30;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .marker:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        #diagram-container.selecting {
            cursor: crosshair;
        }
        .animate-pulse-once {
            animation: pulse-once 1s cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-once {
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                <h1 class="text-2xl font-bold text-gray-900">Visualizador Interactivo de Árbol Coronario</h1>
                <p class="text-sm text-gray-500">Herramienta para el reporte gráfico de lesiones coronarias basado en CAD-RADS™ 2.0</p>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div id="main-content" class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">Diagrama Coronario</h2>
                     <div id="instruction" class="mb-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg">
                        <p><span class="font-bold">Instrucciones:</span> Haz clic en una ubicación del diagrama para añadir un nuevo hallazgo de lesión.</p>
                    </div>
                    <div id="diagram-container" class="relative w-full max-w-3xl mx-auto border-2 border-gray-300 rounded-lg overflow-hidden selecting">
                        <img id="coronary-img" src="esquemaCoronarioColores.png" alt="Diagrama del árbol coronario" class="w-full h-auto block" draggable="false">
                        <div id="markers-container"></div>
                    </div>
                </div>
                
                <div class="lg:col-span-1 space-y-8">
                    <div id="form-container" class="bg-white p-6 rounded-lg shadow-lg transition-all duration-300">
                        <h2 class="text-xl font-semibold mb-4">Añadir Hallazgo</h2>
                        <form id="finding-form" class="space-y-4">
                             <div id="form-message" class="hidden p-3 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg">
                                <p>Ubicación seleccionada. Por favor, complete los detalles de la lesión y guarde el hallazgo.</p>
                            </div>
                            <div>
                                <label for="artery" class="block text-sm font-medium text-gray-700">Arteria / Segmento</label>
                                <select id="artery" name="artery" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <optgroup label="Tronco Coronario Izquierdo">
                                        <option value="TCI">TCI (Tronco Coronario Izquierdo)</option>
                                    </optgroup>
                                    <optgroup label="Arteria Descendente Anterior">
                                        <option value="DAp">DA Proximal</option>
                                        <option value="DAm">DA Media</option>
                                        <option value="DAd">DA Distal</option>
                                        <option value="Dg1">Primera Diagonal (Dg1)</option>
                                        <option value="Dg2">Segunda Diagonal (Dg2)</option>
                                    </optgroup>
                                    <optgroup label="Arteria Circunfleja">
                                        <option value="CXp">CX Proximal</option>
                                        <option value="CXd">CX Distal</option>
                                        <option value="OM1">Primera Obtusa Marginal (OM1)</option>
                                        <option value="OM2">Segunda Obtusa Marginal (OM2)</option>
                                        <option value="PL">Póstero-Lateral</option>
                                    </optgroup>
                                    <optgroup label="Arteria Coronaria Derecha">
                                        <option value="CDp">CD Proximal</option>
                                        <option value="CDm">CD Media</option>
                                        <option value="CDd">CD Distal</option>
                                        <option value="DP">Descendente Posterior</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label for="cads-rads" class="block text-sm font-medium text-gray-700">Grado CAD-RADS</label>
                                <select id="cads-rads" name="cads-rads" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="0">0: Ausencia de placa (0%)</option>
                                    <option value="1">1: Estenosis mínima (1-24%)</option>
                                    <option value="2">2: Estenosis leve (25-49%)</option>
                                    <option value="3">3: Estenosis moderada (50-69%)</option>
                                    <option value="4">4: Estenosis severa (70-99%)</option>
                                    <option value="5">5: Oclusión total (100%)</option>
                                </select>
                            </div>
                            <input type="hidden" id="coord-x">
                            <input type="hidden" id="coord-y">
                            <div class="flex space-x-2">
                                <button type="submit" id="save-finding-btn" disabled class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed">Guardar Hallazgo</button>
                                <button type="button" id="cancel-finding-btn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Simbología (CAD-RADS)</h2>
                        <div class="space-y-3">
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-gray-500 mr-3 border-2 border-white shadow-md"></div><span><b>0:</b> Ausencia de placa</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-green-500 mr-3 border-2 border-white shadow-md"></div><span><b>1:</b> Estenosis mínima (1-24%)</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-yellow-400 mr-3 border-2 border-white shadow-md"></div><span><b>2:</b> Estenosis leve (25-49%)</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-orange-500 mr-3 border-2 border-white shadow-md"></div><span><b>3:</b> Estenosis moderada (50-69%)</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-red-600 mr-3 border-2 border-white shadow-md"></div><span><b>4:</b> Estenosis severa (70-99%)</span></div>
                            <div class="flex items-center"><div class="w-5 h-5 rounded-full bg-black mr-3 border-2 border-white shadow-md"></div><span><b>5:</b> Oclusión total (100%)</span></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Resumen de Hallazgos</h2>
                        <div id="findings-list" class="space-y-3">
                            <p class="text-gray-500">Aún no se han añadido hallazgos.</p>
                        </div>
                        <div class="mt-6 flex space-x-2">
                            <button id="export-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Exportar Reporte (PNG)</button>
                            <button id="clear-btn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Limpiar Todo</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const diagramContainer = document.getElementById('diagram-container');
            const markersContainer = document.getElementById('markers-container');
            const form = document.getElementById('finding-form');
            const findingsList = document.getElementById('findings-list');
            const saveBtn = document.getElementById('save-finding-btn');
            const cancelBtn = document.getElementById('cancel-finding-btn');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const formMessage = document.getElementById('form-message');
            const instructionMessage = document.getElementById('instruction');
            const formContainer = document.getElementById('form-container');

            let findings = [];
            let currentClickCoords = null;
            let findingIdCounter = 0;

            const cadsColors = {
                '0': 'bg-gray-500',
                '1': 'bg-green-500',
                '2': 'bg-yellow-400',
                '3': 'bg-orange-500',
                '4': 'bg-red-600',
                '5': 'bg-black',
            };
            
            const cadsDescriptions = {
                '0': 'CAD-RADS 0: Ausencia de placa (0%)',
                '1': 'CAD-RADS 1: Estenosis mínima (1-24%)',
                '2': 'CAD-RADS 2: Estenosis leve (25-49%)',
                '3': 'CAD-RADS 3: Estenosis moderada (50-69%)',
                '4': 'CAD-RADS 4: Estenosis severa (70-99%)',
                '5': 'CAD-RADS 5: Oclusión total (100%)'
            };

            function renderFindings() {
                markersContainer.innerHTML = '';
                findingsList.innerHTML = '';

                if (findings.length === 0) {
                    findingsList.innerHTML = '<p class="text-gray-500">Aún no se han añadido hallazgos.</p>';
                } else {
                    findings.forEach(finding => {
                        const marker = document.createElement('div');
                        marker.className = `marker ${cadsColors[finding.cadsRads]}`;
                        marker.style.left = `${finding.xPercent}%`;
                        marker.style.top = `${finding.yPercent}%`;
                        marker.dataset.id = finding.id;
                        marker.innerHTML = `
                            ${finding.cadsRads}
                            <span class="tooltip">${finding.artery}: ${cadsDescriptions[finding.cadsRads]}</span>
                        `;
                        markersContainer.appendChild(marker);

                        const listItem = document.createElement('div');
                        listItem.className = 'p-3 border rounded-md hover:bg-gray-50 cursor-pointer flex justify-between items-center';
                        listItem.dataset.id = finding.id;
                        listItem.innerHTML = `
                            <div>
                                <p class="font-semibold">${finding.artery}</p>
                                <p class="text-sm text-gray-600">${cadsDescriptions[finding.cadsRads]}</p>
                            </div>
                            <button class="delete-finding-btn text-red-500 hover:text-red-700 text-xs" data-id="${finding.id}">Eliminar</button>
                        `;
                        findingsList.appendChild(listItem);
                    });
                }
                addEventListenersToItems();
            }

            function addEventListenersToItems() {
                document.querySelectorAll('.marker, [data-id]').forEach(el => {
                    el.addEventListener('mouseenter', handleMouseEnter);
                    el.addEventListener('mouseleave', handleMouseLeave);
                });
                
                document.querySelectorAll('.delete-finding-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const idToDelete = parseInt(e.target.dataset.id, 10);
                        findings = findings.filter(f => f.id !== idToDelete);
                        renderFindings();
                    });
                });
            }
            
            function handleMouseEnter(e) {
                const id = e.currentTarget.dataset.id;
                if (!id) return;
                document.querySelectorAll(`[data-id="${id}"]`).forEach(el => el.classList.add('highlight'));
            }

            function handleMouseLeave(e) {
                const id = e.currentTarget.dataset.id;
                 if (!id) return;
                document.querySelectorAll(`[data-id="${id}"]`).forEach(el => el.classList.remove('highlight'));
            }

            function resetFormState() {
                currentClickCoords = null;
                form.reset();
                saveBtn.disabled = true;
                diagramContainer.classList.add('selecting');
                formMessage.classList.add('hidden');
                instructionMessage.classList.remove('hidden');
                formContainer.classList.remove('ring-2', 'ring-indigo-500');
            }

            diagramContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('marker') || e.target.parentElement.classList.contains('marker')) {
                    return;
                }
                const rect = diagramContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                currentClickCoords = {
                    xPercent: (x / rect.width) * 100,
                    yPercent: (y / rect.height) * 100,
                };

                saveBtn.disabled = false;
                diagramContainer.classList.remove('selecting');
                instructionMessage.classList.add('hidden');
                formMessage.classList.remove('hidden');
                formContainer.classList.add('ring-2', 'ring-indigo-500', 'animate-pulse-once');
                setTimeout(() => formContainer.classList.remove('animate-pulse-once'), 1000);
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!currentClickCoords) return;

                const newFinding = {
                    id: findingIdCounter++,
                    artery: form.elements['artery'].value,
                    cadsRads: form.elements['cads-rads'].value,
                    ...currentClickCoords,
                };

                findings.push(newFinding);
                renderFindings();
                resetFormState();
            });
            
            cancelBtn.addEventListener('click', resetFormState);

            clearBtn.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que deseas eliminar todos los hallazgos?')) {
                    findings = [];
                    renderFindings();
                    resetFormState();
                }
            });

            exportBtn.addEventListener('click', () => {
                const contentToExport = document.getElementById('main-content');
                html2canvas(contentToExport, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'reporte-coronario.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            });

            renderFindings();
        });
    </script>
</body>
</html>
